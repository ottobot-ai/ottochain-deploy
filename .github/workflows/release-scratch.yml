name: Release from Scratch

on:
  push:
    branches:
      - release/scratch
  workflow_dispatch:
    inputs:
      wipe_state:
        description: 'Wipe all state (genesis reset)'
        required: true
        default: 'true'
        type: boolean
      skip_build:
        description: 'Skip JAR build (use existing)'
        required: false
        default: 'false'
        type: boolean

env:
  TESSELLATION_VERSION: v4.0.0-rc.2
  JAVA_VERSION: '21'
  SBT_VERSION: '1.10.11'

jobs:
  build:
    name: Build Metagraph JARs
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_build != 'true' }}
    
    steps:
      - name: Checkout ottochain-deploy
        uses: actions/checkout@v4
        
      - name: Checkout ottochain
        uses: actions/checkout@v4
        with:
          repository: ottobot-ai/ottochain
          path: ottochain
          
      - name: Checkout tessellation
        uses: actions/checkout@v4
        with:
          repository: Constellation-Labs/tessellation
          ref: ${{ env.TESSELLATION_VERSION }}
          path: tessellation
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'sbt'
          
      - name: Build tessellation SDK
        working-directory: tessellation
        run: |
          # Fix compile error in v4.0.0-rc.2
          sed -i 's/def make\[F\[_\]/def make[F[_]]: GlobalSnapshotStateChannelEventsProcessor[F] =/g' \
            modules/node-shared/src/main/scala/org/tessellation/node/shared/infrastructure/snapshot/GlobalSnapshotStateChannelEventsProcessor.scala || true
          sbt sdk/publishLocal
          
      - name: Build metagraph JARs
        working-directory: ottochain
        run: |
          sbt assembly
          
      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          cp ottochain/modules/l0/target/scala-2.13/ottochain-l0-assembly-*.jar artifacts/metagraph-l0.jar
          cp ottochain/modules/l1/target/scala-2.13/ottochain-l1-assembly-*.jar artifacts/currency-l1.jar
          cp ottochain/modules/data-l1/target/scala-2.13/ottochain-data-l1-assembly-*.jar artifacts/data-l1.jar
          ls -la artifacts/
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: metagraph-jars
          path: artifacts/
          retention-days: 7

  deploy:
    name: Deploy to Hetzner
    runs-on: ubuntu-latest
    needs: [build]
    if: always() && (needs.build.result == 'success' || github.event.inputs.skip_build == 'true')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Download artifacts
        if: ${{ github.event.inputs.skip_build != 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: metagraph-jars
          path: artifacts/
          
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/hetzner
          chmod 600 ~/.ssh/hetzner
          cat >> ~/.ssh/config << EOF
          Host node1
            HostName ${{ secrets.HETZNER_NODE1_IP }}
            User root
            IdentityFile ~/.ssh/hetzner
            StrictHostKeyChecking no
          Host node2
            HostName ${{ secrets.HETZNER_NODE2_IP }}
            User root
            IdentityFile ~/.ssh/hetzner
            StrictHostKeyChecking no
          Host node3
            HostName ${{ secrets.HETZNER_NODE3_IP }}
            User root
            IdentityFile ~/.ssh/hetzner
            StrictHostKeyChecking no
          Host services
            HostName ${{ secrets.HETZNER_SERVICES_IP }}
            User root
            IdentityFile ~/.ssh/hetzner
            StrictHostKeyChecking no
          EOF
          
      - name: Stop all services
        run: |
          echo "=== Stopping all services ==="
          for host in node1 node2 node3; do
            echo "Stopping $host..."
            ssh $host 'docker ps -q | xargs -r docker stop || true' &
          done
          wait
          ssh services 'cd /opt/ottochain-services && docker compose down || true'
          echo "All services stopped"
          
      - name: Wipe state (if requested)
        if: ${{ github.event.inputs.wipe_state != 'false' }}
        run: |
          echo "=== Wiping state on all nodes ==="
          for host in node1 node2 node3; do
            echo "Wiping $host..."
            ssh $host 'rm -rf /opt/ottochain/data/* || true'
          done
          echo "Wiping services database..."
          ssh services 'docker volume rm ottochain-services_postgres_data || true'
          echo "State wiped"
          
      - name: Deploy JARs
        if: ${{ github.event.inputs.skip_build != 'true' }}
        run: |
          echo "=== Deploying JARs to all nodes ==="
          for host in node1 node2 node3; do
            echo "Deploying to $host..."
            scp artifacts/*.jar $host:/opt/ottochain/jars/
            ssh $host 'ls -la /opt/ottochain/jars/'
          done
          echo "JARs deployed"
          
      - name: Start GL0 (Genesis)
        env:
          CL_KEYSTORE_PASSWORD: ${{ secrets.CL_KEYSTORE_PASSWORD }}
        run: |
          echo "=== Starting GL0 on node1 (genesis) ==="
          ssh node1 << 'SCRIPT'
          cd /opt/ottochain
          export CL_KEYSTORE_PASSWORD="${{ secrets.CL_KEYSTORE_PASSWORD }}"
          export CL_KEYSTORE=/opt/ottochain/keys/cl-keystore.p12
          export CL_KEY_ALIAS=cl-keystore
          
          docker run -d --name gl0 \
            --network host \
            -v /opt/ottochain/jars:/jars:ro \
            -v /opt/ottochain/keys:/keys:ro \
            -v /opt/ottochain/data/gl0:/data \
            -e CL_KEYSTORE=$CL_KEYSTORE \
            -e CL_KEYSTORE_PASSWORD=$CL_KEYSTORE_PASSWORD \
            -e CL_KEY_ALIAS=$CL_KEY_ALIAS \
            -e CL_PUBLIC_HTTP_PORT=9000 \
            -e CL_P2P_HTTP_PORT=9001 \
            -e CL_CLI_HTTP_PORT=9002 \
            eclipse-temurin:21-jre \
            java -jar /jars/metagraph-l0.jar run-genesis /data/genesis.snapshot \
              --ip $(hostname -I | awk '{print $1}')
          SCRIPT
          
          echo "Waiting for GL0 to become Ready..."
          for i in {1..60}; do
            state=$(ssh node1 'curl -s http://localhost:9000/node/info | jq -r .state' 2>/dev/null || echo "")
            if [ "$state" = "Ready" ]; then
              echo "GL0 is Ready"
              break
            fi
            echo "Waiting... ($i/60) state=$state"
            sleep 5
          done
          
      - name: Start GL0 (Join nodes 2,3)
        env:
          CL_KEYSTORE_PASSWORD: ${{ secrets.CL_KEYSTORE_PASSWORD }}
        run: |
          GENESIS_IP="${{ secrets.HETZNER_NODE1_IP }}"
          GENESIS_ID=$(ssh node1 'curl -s http://localhost:9000/node/info | jq -r .id')
          
          for host in node2 node3; do
            echo "=== Starting GL0 on $host (join) ==="
            ssh $host << SCRIPT
            cd /opt/ottochain
            export CL_KEYSTORE_PASSWORD="${{ secrets.CL_KEYSTORE_PASSWORD }}"
            
            docker run -d --name gl0 \
              --network host \
              -v /opt/ottochain/jars:/jars:ro \
              -v /opt/ottochain/keys:/keys:ro \
              -v /opt/ottochain/data/gl0:/data \
              -e CL_KEYSTORE=/opt/ottochain/keys/cl-keystore.p12 \
              -e CL_KEYSTORE_PASSWORD=\$CL_KEYSTORE_PASSWORD \
              -e CL_KEY_ALIAS=cl-keystore \
              -e CL_PUBLIC_HTTP_PORT=9000 \
              -e CL_P2P_HTTP_PORT=9001 \
              -e CL_CLI_HTTP_PORT=9002 \
              -e CL_GLOBAL_L0_PEER_HTTP_HOST=$GENESIS_IP \
              -e CL_GLOBAL_L0_PEER_HTTP_PORT=9000 \
              -e CL_GLOBAL_L0_PEER_ID=$GENESIS_ID \
              eclipse-temurin:21-jre \
              java -jar /jars/metagraph-l0.jar run-validator \
                --ip \$(hostname -I | awk '{print \$1}')
          SCRIPT
          done
          
          echo "Waiting for GL0 cluster (3 nodes)..."
          for i in {1..60}; do
            count=$(ssh node1 'curl -s http://localhost:9000/cluster/info | jq length' 2>/dev/null || echo "0")
            if [ "$count" = "3" ]; then
              echo "GL0 cluster formed: $count nodes"
              break
            fi
            echo "Waiting... ($i/60) nodes=$count"
            sleep 5
          done
          
      - name: Start ML0 (Genesis)
        env:
          CL_KEYSTORE_PASSWORD: ${{ secrets.CL_KEYSTORE_PASSWORD }}
        run: |
          GENESIS_IP="${{ secrets.HETZNER_NODE1_IP }}"
          GENESIS_ID=$(ssh node1 'curl -s http://localhost:9000/node/info | jq -r .id')
          
          echo "=== Creating ML0 genesis ==="
          ssh node1 << SCRIPT
          cd /opt/ottochain
          
          # Create genesis CSV if not exists
          if [ ! -f /opt/ottochain/data/genesis.csv ]; then
            echo "DAG0JjJkmwDn8s9QTyykPRqnvkagxSkrLfDG1mYz,1000000000000000" > /opt/ottochain/data/genesis.csv
          fi
          
          # Run create-genesis
          docker run --rm \
            -v /opt/ottochain/jars:/jars:ro \
            -v /opt/ottochain/keys:/keys:ro \
            -v /opt/ottochain/data/ml0:/data \
            -e CL_KEYSTORE=/opt/ottochain/keys/cl-keystore.p12 \
            -e CL_KEYSTORE_PASSWORD="${{ secrets.CL_KEYSTORE_PASSWORD }}" \
            -e CL_KEY_ALIAS=cl-keystore \
            eclipse-temurin:21-jre \
            java -jar /jars/metagraph-l0.jar create-genesis /data/genesis.csv
          
          ls -la /opt/ottochain/data/ml0/
          SCRIPT
          
          echo "=== Starting ML0 ==="
          ssh node1 << SCRIPT
          docker run -d --name ml0 \
            --network host \
            -v /opt/ottochain/jars:/jars:ro \
            -v /opt/ottochain/keys:/keys:ro \
            -v /opt/ottochain/data/ml0:/data \
            -e CL_KEYSTORE=/opt/ottochain/keys/cl-keystore.p12 \
            -e CL_KEYSTORE_PASSWORD="${{ secrets.CL_KEYSTORE_PASSWORD }}" \
            -e CL_KEY_ALIAS=cl-keystore \
            -e CL_PUBLIC_HTTP_PORT=9200 \
            -e CL_P2P_HTTP_PORT=9201 \
            -e CL_CLI_HTTP_PORT=9202 \
            -e CL_GLOBAL_L0_PEER_HTTP_HOST=$GENESIS_IP \
            -e CL_GLOBAL_L0_PEER_HTTP_PORT=9000 \
            -e CL_GLOBAL_L0_PEER_ID=$GENESIS_ID \
            eclipse-temurin:21-jre \
            java -jar /jars/metagraph-l0.jar run-genesis /data/genesis.snapshot \
              --ip \$(hostname -I | awk '{print \$1}')
          SCRIPT
          
          echo "Waiting for ML0 to become Ready..."
          for i in {1..60}; do
            state=$(ssh node1 'curl -s http://localhost:9200/node/info | jq -r .state' 2>/dev/null || echo "")
            if [ "$state" = "Ready" ]; then
              echo "ML0 is Ready"
              break
            fi
            echo "Waiting... ($i/60) state=$state"
            sleep 5
          done
          
      - name: Start CL1 (3 nodes)
        env:
          CL_KEYSTORE_PASSWORD: ${{ secrets.CL_KEYSTORE_PASSWORD }}
        run: |
          GENESIS_IP="${{ secrets.HETZNER_NODE1_IP }}"
          GL0_ID=$(ssh node1 'curl -s http://localhost:9000/node/info | jq -r .id')
          ML0_ID=$(ssh node1 'curl -s http://localhost:9200/node/info | jq -r .id')
          
          port=9300
          for host in node1 node2 node3; do
            echo "=== Starting CL1 on $host ==="
            ssh $host << SCRIPT
            docker run -d --name cl1 \
              --network host \
              -v /opt/ottochain/jars:/jars:ro \
              -v /opt/ottochain/keys:/keys:ro \
              -v /opt/ottochain/data/cl1:/data \
              -e CL_KEYSTORE=/opt/ottochain/keys/cl-keystore.p12 \
              -e CL_KEYSTORE_PASSWORD="${{ secrets.CL_KEYSTORE_PASSWORD }}" \
              -e CL_KEY_ALIAS=cl-keystore \
              -e CL_PUBLIC_HTTP_PORT=$port \
              -e CL_P2P_HTTP_PORT=$((port+1)) \
              -e CL_CLI_HTTP_PORT=$((port+2)) \
              -e CL_GLOBAL_L0_PEER_HTTP_HOST=$GENESIS_IP \
              -e CL_GLOBAL_L0_PEER_HTTP_PORT=9000 \
              -e CL_GLOBAL_L0_PEER_ID=$GL0_ID \
              -e CL_L0_PEER_HTTP_HOST=$GENESIS_IP \
              -e CL_L0_PEER_HTTP_PORT=9200 \
              -e CL_L0_PEER_ID=$ML0_ID \
              -e CL_L0_TOKEN_IDENTIFIER=DAG0JjJkmwDn8s9QTyykPRqnvkagxSkrLfDG1mYz \
              eclipse-temurin:21-jre \
              java -jar /jars/currency-l1.jar run-validator \
                --ip \$(hostname -I | awk '{print \$1}')
          SCRIPT
          done
          
          echo "Waiting for CL1 cluster (3 nodes)..."
          sleep 30
          for i in {1..60}; do
            count=$(ssh node1 'curl -s http://localhost:9300/cluster/info | jq length' 2>/dev/null || echo "0")
            if [ "$count" = "3" ]; then
              echo "CL1 cluster formed: $count nodes"
              break
            fi
            echo "Waiting... ($i/60) nodes=$count"
            sleep 5
          done
          
      - name: Start DL1 (3 nodes)
        env:
          CL_KEYSTORE_PASSWORD: ${{ secrets.CL_KEYSTORE_PASSWORD }}
        run: |
          GENESIS_IP="${{ secrets.HETZNER_NODE1_IP }}"
          GL0_ID=$(ssh node1 'curl -s http://localhost:9000/node/info | jq -r .id')
          ML0_ID=$(ssh node1 'curl -s http://localhost:9200/node/info | jq -r .id')
          
          port=9400
          for host in node1 node2 node3; do
            echo "=== Starting DL1 on $host ==="
            ssh $host << SCRIPT
            docker run -d --name dl1 \
              --network host \
              -v /opt/ottochain/jars:/jars:ro \
              -v /opt/ottochain/keys:/keys:ro \
              -v /opt/ottochain/data/dl1:/data \
              -e CL_KEYSTORE=/opt/ottochain/keys/cl-keystore.p12 \
              -e CL_KEYSTORE_PASSWORD="${{ secrets.CL_KEYSTORE_PASSWORD }}" \
              -e CL_KEY_ALIAS=cl-keystore \
              -e CL_PUBLIC_HTTP_PORT=$port \
              -e CL_P2P_HTTP_PORT=$((port+1)) \
              -e CL_CLI_HTTP_PORT=$((port+2)) \
              -e CL_GLOBAL_L0_PEER_HTTP_HOST=$GENESIS_IP \
              -e CL_GLOBAL_L0_PEER_HTTP_PORT=9000 \
              -e CL_GLOBAL_L0_PEER_ID=$GL0_ID \
              -e CL_L0_PEER_HTTP_HOST=$GENESIS_IP \
              -e CL_L0_PEER_HTTP_PORT=9200 \
              -e CL_L0_PEER_ID=$ML0_ID \
              -e CL_L0_TOKEN_IDENTIFIER=DAG0JjJkmwDn8s9QTyykPRqnvkagxSkrLfDG1mYz \
              eclipse-temurin:21-jre \
              java -jar /jars/data-l1.jar run-validator \
                --ip \$(hostname -I | awk '{print \$1}')
          SCRIPT
          done
          
          echo "Waiting for DL1 cluster (3 nodes)..."
          sleep 30
          for i in {1..60}; do
            count=$(ssh node1 'curl -s http://localhost:9400/cluster/info | jq length' 2>/dev/null || echo "0")
            if [ "$count" = "3" ]; then
              echo "DL1 cluster formed: $count nodes"
              break
            fi
            echo "Waiting... ($i/60) nodes=$count"
            sleep 5
          done

  services:
    name: Deploy Services
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() && needs.deploy.result == 'success'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/hetzner
          chmod 600 ~/.ssh/hetzner
          cat >> ~/.ssh/config << EOF
          Host services
            HostName ${{ secrets.HETZNER_SERVICES_IP }}
            User root
            IdentityFile ~/.ssh/hetzner
            StrictHostKeyChecking no
          EOF
          
      - name: Deploy services
        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          METAGRAPH_ML0_URL: http://${{ secrets.HETZNER_NODE1_IP }}:9200
        run: |
          echo "=== Deploying services ==="
          ssh services << SCRIPT
          cd /opt/ottochain-services
          
          # Update .env
          cat > .env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          DATABASE_URL=postgresql://ottochain:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/ottochain
          METAGRAPH_ML0_URL=http://${{ secrets.HETZNER_NODE1_IP }}:9200
          METAGRAPH_DL1_URL=http://${{ secrets.HETZNER_NODE1_IP }}:9400
          PORT=3030
          EOF
          
          # Start services
          docker compose up -d postgres
          sleep 10
          
          # Run migrations
          docker compose run --rm gateway npx prisma migrate deploy
          
          # Start all services
          docker compose up -d
          
          echo "Services started"
          docker compose ps
          SCRIPT
          
      - name: Trigger initial index
        run: |
          sleep 30
          ORDINAL=$(ssh services "curl -s http://${{ secrets.HETZNER_NODE1_IP }}:9200/snapshots/latest | jq -r '.ordinal'" || echo "0")
          ssh services "curl -X POST http://localhost:3031/webhook/snapshot -H 'Content-Type: application/json' -d '{\"ordinal\": $ORDINAL, \"hash\": \"init\", \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}'" || true
          
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [services]
    if: always() && needs.services.result == 'success'
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/hetzner
          chmod 600 ~/.ssh/hetzner
          echo "Host node1" >> ~/.ssh/config
          echo "  HostName ${{ secrets.HETZNER_NODE1_IP }}" >> ~/.ssh/config
          echo "  User root" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/hetzner" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "Host services" >> ~/.ssh/config
          echo "  HostName ${{ secrets.HETZNER_SERVICES_IP }}" >> ~/.ssh/config
          echo "  User root" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/hetzner" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          
      - name: Check metagraph health
        run: |
          echo "=== Health Check ==="
          echo ""
          echo "GL0:"
          ssh node1 'curl -s http://localhost:9000/node/info | jq "{state, id: .id[0:16]}"'
          GL0_CLUSTER=$(ssh node1 'curl -s http://localhost:9000/cluster/info | jq length')
          echo "Cluster size: $GL0_CLUSTER"
          
          echo ""
          echo "ML0:"
          ssh node1 'curl -s http://localhost:9200/node/info | jq "{state}"'
          ORDINAL=$(ssh node1 'curl -s http://localhost:9200/snapshots/latest | jq .ordinal')
          echo "Latest ordinal: $ORDINAL"
          
          echo ""
          echo "CL1:"
          CL1_CLUSTER=$(ssh node1 'curl -s http://localhost:9300/cluster/info | jq length')
          echo "Cluster size: $CL1_CLUSTER"
          
          echo ""
          echo "DL1:"
          DL1_CLUSTER=$(ssh node1 'curl -s http://localhost:9400/cluster/info | jq length')
          echo "Cluster size: $DL1_CLUSTER"
          
          echo ""
          echo "Explorer:"
          ssh services 'curl -s http://localhost:8080 | head -c 100' || echo "Not responding"
          
          echo ""
          echo "=== Summary ==="
          if [ "$GL0_CLUSTER" = "3" ] && [ "$CL1_CLUSTER" = "3" ] && [ "$DL1_CLUSTER" = "3" ]; then
            echo "âœ… All clusters healthy (3 nodes each)"
          else
            echo "âš ï¸ Cluster sizes: GL0=$GL0_CLUSTER CL1=$CL1_CLUSTER DL1=$DL1_CLUSTER"
          fi
          
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| GL0 | $(ssh node1 'curl -s http://localhost:9000/node/info | jq -r .state') |" >> $GITHUB_STEP_SUMMARY
          echo "| ML0 | $(ssh node1 'curl -s http://localhost:9200/node/info | jq -r .state') |" >> $GITHUB_STEP_SUMMARY
          echo "| CL1 Cluster | $(ssh node1 'curl -s http://localhost:9300/cluster/info | jq length') nodes |" >> $GITHUB_STEP_SUMMARY
          echo "| DL1 Cluster | $(ssh node1 'curl -s http://localhost:9400/cluster/info | jq length') nodes |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Explorer**: http://${{ secrets.HETZNER_SERVICES_IP }}:8080" >> $GITHUB_STEP_SUMMARY
