name: Deploy OttoChain Cluster

on:
  push:
    branches:
      - release/deploy
  workflow_dispatch:
    inputs:
      fresh_genesis:
        description: 'Fresh genesis (wipe all data)'
        required: true
        default: 'true'
        type: boolean

env:
  NODE1_IP: ${{ secrets.HETZNER_NODE1_IP }}
  NODE2_IP: ${{ secrets.HETZNER_NODE2_IP }}
  NODE3_IP: ${{ secrets.HETZNER_NODE3_IP }}
  SERVICES_IP: ${{ secrets.HETZNER_SERVICES_IP }}

jobs:
  # ============================================
  # SETUP: Configure SSH and validate
  # ============================================
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      node1_ip: ${{ env.NODE1_IP }}
      node2_ip: ${{ env.NODE2_IP }}
      node3_ip: ${{ env.NODE3_IP }}
    steps:
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.HETZNER_SSH_KEY }}" ]; then
            echo "::error::HETZNER_SSH_KEY secret not set"
            exit 1
          fi
          for ip in "$NODE1_IP" "$NODE2_IP" "$NODE3_IP" "$SERVICES_IP"; do
            if [ -z "$ip" ]; then
              echo "::error::Missing node IP secret"
              exit 1
            fi
          done
          echo "All secrets validated"

  # ============================================
  # STOP: Stop all containers on all nodes
  # ============================================
  stop:
    name: Stop Cluster
    runs-on: ubuntu-latest
    needs: [setup]
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
          
      - name: Stop all nodes
        run: |
          for ip in $NODE1_IP $NODE2_IP $NODE3_IP; do
            echo "=== Stopping $ip ==="
            ssh -i ~/.ssh/key root@$ip 'docker rm -f gl0 gl1 ml0 cl1 dl1 2>/dev/null || true' &
          done
          wait
          echo "All stopped"
          
      - name: Clean data (if fresh genesis)
        if: ${{ github.event.inputs.fresh_genesis != 'false' }}
        run: |
          for ip in $NODE1_IP $NODE2_IP $NODE3_IP; do
            echo "Cleaning data on $ip..."
            ssh -i ~/.ssh/key root@$ip 'rm -rf /opt/ottochain/data/* /opt/ottochain/genesis/*' &
          done
          wait
          echo "Data cleaned"

  # ============================================
  # DEPLOY: Copy JARs and docker-compose
  # ============================================
  deploy-files:
    name: Deploy Files
    runs-on: ubuntu-latest
    needs: [stop]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
          
      - name: Copy files to all nodes
        run: |
          for ip in $NODE1_IP $NODE2_IP $NODE3_IP; do
            echo "=== Deploying to $ip ==="
            ssh -i ~/.ssh/key root@$ip 'mkdir -p /opt/ottochain/{jars,keys,data,genesis,scripts}'
            scp -i ~/.ssh/key docker/metagraph/docker-compose.yml root@$ip:/opt/ottochain/
          done
          
      - name: Sync JARs from node1 to others
        run: |
          # Verify JARs exist on node1
          ssh -i ~/.ssh/key root@$NODE1_IP 'ls /opt/ottochain/jars/*.jar | wc -l'
          
          # Copy to node2 and node3
          for ip in $NODE2_IP $NODE3_IP; do
            echo "Syncing JARs to $ip..."
            ssh -i ~/.ssh/key root@$NODE1_IP "cd /opt/ottochain/jars && tar cf - *.jar" | \
              ssh -i ~/.ssh/key root@$ip "cd /opt/ottochain/jars && tar xf -"
          done

  # ============================================
  # START GL0: Global L0 layer
  # ============================================
  start-gl0:
    name: Start GL0
    runs-on: ubuntu-latest
    needs: [deploy-files]
    outputs:
      peer_id: ${{ steps.get-id.outputs.peer_id }}
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
          
      - name: Create genesis CSV (node1)
        if: ${{ github.event.inputs.fresh_genesis != 'false' }}
        run: |
          WALLET=$(ssh -i ~/.ssh/key root@$NODE1_IP "docker run --rm \
            -e CL_KEYSTORE=/keys/key.p12 \
            -e CL_KEYALIAS=alias \
            -e CL_PASSWORD=${{ secrets.CL_KEYSTORE_PASSWORD }} \
            -v /opt/ottochain/keys:/keys \
            -v /opt/ottochain/jars:/jars \
            eclipse-temurin:21-jdk java -jar /jars/cl-wallet.jar show-address 2>/dev/null | grep -oP 'DAG[a-zA-Z0-9]+'")
          echo "Genesis wallet: $WALLET"
          ssh -i ~/.ssh/key root@$NODE1_IP "echo '$WALLET,1000000000000000' > /opt/ottochain/genesis/genesis.csv"
          
      - name: Start GL0 genesis (node1)
        run: |
          ssh -i ~/.ssh/key root@$NODE1_IP "cd /opt/ottochain && \
            NODE_IP=$NODE1_IP \
            CL_PASSWORD=${{ secrets.CL_KEYSTORE_PASSWORD }} \
            docker compose --profile genesis up -d gl0-genesis"
            
          echo "Waiting for GL0 to be ready..."
          for i in {1..60}; do
            state=$(ssh -i ~/.ssh/key root@$NODE1_IP 'curl -sf http://localhost:9000/node/info | jq -r .state' || echo "")
            if [ "$state" = "Ready" ]; then
              echo "GL0 is Ready"
              break
            fi
            echo "Waiting... ($i/60) state=$state"
            sleep 5
          done
          
      - name: Get GL0 peer ID
        id: get-id
        run: |
          PEER_ID=$(ssh -i ~/.ssh/key root@$NODE1_IP 'curl -sf http://localhost:9000/node/info | jq -r .id')
          echo "peer_id=$PEER_ID" >> $GITHUB_OUTPUT
          echo "GL0 Peer ID: ${PEER_ID:0:20}..."
          
      - name: Start GL0 validators (node2, node3)
        run: |
          GL0_PEER_ID="${{ steps.get-id.outputs.peer_id }}"
          
          for ip in $NODE2_IP $NODE3_IP; do
            echo "Starting GL0 validator on $ip..."
            ssh -i ~/.ssh/key root@$ip "cd /opt/ottochain && \
              NODE_IP=$ip \
              GENESIS_IP=$NODE1_IP \
              GL0_PEER_ID=$GL0_PEER_ID \
              CL_PASSWORD=${{ secrets.CL_KEYSTORE_PASSWORD }} \
              docker compose --profile validator up -d gl0-validator"
          done
          
          sleep 20
          
          # Join validators to cluster
          for ip in $NODE2_IP $NODE3_IP; do
            echo "Joining $ip to GL0 cluster..."
            ssh -i ~/.ssh/key root@$ip "docker exec gl0 curl -sf -X POST http://127.0.0.1:9002/cluster/join \
              -H 'Content-Type: application/json' \
              -d '{\"id\": \"$GL0_PEER_ID\", \"ip\": \"$NODE1_IP\", \"p2pPort\": 9001}'" || true
          done
          
          sleep 10
          CLUSTER=$(ssh -i ~/.ssh/key root@$NODE1_IP 'curl -sf http://localhost:9000/cluster/info | jq length')
          echo "GL0 cluster size: $CLUSTER"

  # ============================================
  # START GL1: Global L1 layer
  # ============================================
  start-gl1:
    name: Start GL1
    runs-on: ubuntu-latest
    needs: [start-gl0]
    outputs:
      peer_id: ${{ steps.get-id.outputs.peer_id }}
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
          
      - name: Start GL1 initial (node1)
        run: |
          GL0_PEER_ID="${{ needs.start-gl0.outputs.peer_id }}"
          
          ssh -i ~/.ssh/key root@$NODE1_IP "cd /opt/ottochain && \
            NODE_IP=$NODE1_IP \
            GL0_PEER_ID=$GL0_PEER_ID \
            CL_PASSWORD=${{ secrets.CL_KEYSTORE_PASSWORD }} \
            docker compose --profile genesis up -d gl1-initial"
            
          echo "Waiting for GL1 to be ready..."
          for i in {1..60}; do
            state=$(ssh -i ~/.ssh/key root@$NODE1_IP 'curl -sf http://localhost:9100/node/info | jq -r .state' || echo "")
            if [ "$state" = "Ready" ]; then
              echo "GL1 is Ready"
              break
            fi
            echo "Waiting... ($i/60) state=$state"
            sleep 5
          done
          
      - name: Get GL1 peer ID
        id: get-id
        run: |
          PEER_ID=$(ssh -i ~/.ssh/key root@$NODE1_IP 'curl -sf http://localhost:9100/node/info | jq -r .id')
          echo "peer_id=$PEER_ID" >> $GITHUB_OUTPUT
          echo "GL1 Peer ID: ${PEER_ID:0:20}..."
          
      - name: Start GL1 validators
        run: |
          GL0_PEER_ID="${{ needs.start-gl0.outputs.peer_id }}"
          GL1_PEER_ID="${{ steps.get-id.outputs.peer_id }}"
          
          for ip in $NODE2_IP $NODE3_IP; do
            echo "Starting GL1 validator on $ip..."
            ssh -i ~/.ssh/key root@$ip "cd /opt/ottochain && \
              NODE_IP=$ip \
              GENESIS_IP=$NODE1_IP \
              GL0_PEER_ID=$GL0_PEER_ID \
              GL1_PEER_ID=$GL1_PEER_ID \
              CL_PASSWORD=${{ secrets.CL_KEYSTORE_PASSWORD }} \
              docker compose --profile validator up -d gl1-validator"
          done
          
          sleep 20
          
          for ip in $NODE2_IP $NODE3_IP; do
            ssh -i ~/.ssh/key root@$ip "docker exec gl1 curl -sf -X POST http://127.0.0.1:9102/cluster/join \
              -H 'Content-Type: application/json' \
              -d '{\"id\": \"$GL1_PEER_ID\", \"ip\": \"$NODE1_IP\", \"p2pPort\": 9101}'" || true
          done
          
          sleep 10
          CLUSTER=$(ssh -i ~/.ssh/key root@$NODE1_IP 'curl -sf http://localhost:9100/cluster/info | jq length')
          echo "GL1 cluster size: $CLUSTER"

  # ============================================
  # START ML0: Metagraph L0 layer
  # ============================================
  start-ml0:
    name: Start ML0
    runs-on: ubuntu-latest
    needs: [start-gl1]
    outputs:
      peer_id: ${{ steps.get-id.outputs.peer_id }}
      token_id: ${{ steps.get-token.outputs.token_id }}
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
          
      - name: Create ML0 genesis snapshot
        if: ${{ github.event.inputs.fresh_genesis != 'false' }}
        run: |
          ssh -i ~/.ssh/key root@$NODE1_IP "docker run --rm \
            -e CL_KEYSTORE=/keys/key.p12 \
            -e CL_KEYALIAS=alias \
            -e CL_PASSWORD=${{ secrets.CL_KEYSTORE_PASSWORD }} \
            -v /opt/ottochain/keys:/keys \
            -v /opt/ottochain/jars:/jars \
            -v /opt/ottochain/data:/data \
            -v /opt/ottochain/genesis:/genesis:ro \
            -w /data \
            eclipse-temurin:21-jdk java -jar /jars/metagraph-l0.jar create-genesis /genesis/genesis.csv"
            
      - name: Start ML0 genesis (node1)
        run: |
          GL0_PEER_ID="${{ needs.start-gl0.outputs.peer_id }}"
          
          ssh -i ~/.ssh/key root@$NODE1_IP "cd /opt/ottochain && \
            NODE_IP=$NODE1_IP \
            GL0_PEER_ID=$GL0_PEER_ID \
            CL_PASSWORD=${{ secrets.CL_KEYSTORE_PASSWORD }} \
            docker compose --profile genesis up -d ml0-genesis"
            
          for i in {1..60}; do
            state=$(ssh -i ~/.ssh/key root@$NODE1_IP 'curl -sf http://localhost:9200/node/info | jq -r .state' || echo "")
            if [ "$state" = "Ready" ]; then
              echo "ML0 is Ready"
              break
            fi
            sleep 5
          done
          
      - name: Get ML0 peer ID
        id: get-id
        run: |
          PEER_ID=$(ssh -i ~/.ssh/key root@$NODE1_IP 'curl -sf http://localhost:9200/node/info | jq -r .id')
          echo "peer_id=$PEER_ID" >> $GITHUB_OUTPUT
          
      - name: Get token ID
        id: get-token
        run: |
          TOKEN_ID=$(ssh -i ~/.ssh/key root@$NODE1_IP 'curl -sf http://localhost:9000/global-snapshots/latest | jq -r ".value.stateChannelSnapshots | keys[0]"')
          echo "token_id=$TOKEN_ID" >> $GITHUB_OUTPUT
          echo "Token ID: ${TOKEN_ID:0:20}..."
          
      - name: Start ML0 validators
        run: |
          GL0_PEER_ID="${{ needs.start-gl0.outputs.peer_id }}"
          ML0_PEER_ID="${{ steps.get-id.outputs.peer_id }}"
          TOKEN_ID="${{ steps.get-token.outputs.token_id }}"
          
          for ip in $NODE2_IP $NODE3_IP; do
            ssh -i ~/.ssh/key root@$ip "cd /opt/ottochain && \
              NODE_IP=$ip \
              GENESIS_IP=$NODE1_IP \
              GL0_PEER_ID=$GL0_PEER_ID \
              ML0_PEER_ID=$ML0_PEER_ID \
              TOKEN_ID=$TOKEN_ID \
              CL_PASSWORD=${{ secrets.CL_KEYSTORE_PASSWORD }} \
              docker compose --profile validator up -d ml0-validator"
          done
          
          sleep 25
          
          for ip in $NODE2_IP $NODE3_IP; do
            ssh -i ~/.ssh/key root@$ip "docker exec ml0 curl -sf -X POST http://127.0.0.1:9202/cluster/join \
              -H 'Content-Type: application/json' \
              -d '{\"id\": \"$ML0_PEER_ID\", \"ip\": \"$NODE1_IP\", \"p2pPort\": 9201}'" || true
          done
          
          sleep 10
          CLUSTER=$(ssh -i ~/.ssh/key root@$NODE1_IP 'curl -sf http://localhost:9200/cluster/info | jq length')
          echo "ML0 cluster size: $CLUSTER"

  # ============================================
  # START CL1 & DL1: L1 layers
  # ============================================
  start-l1:
    name: Start CL1 & DL1
    runs-on: ubuntu-latest
    needs: [start-ml0]
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
          
      - name: Start CL1 & DL1 on all nodes
        run: |
          GL0_PEER_ID="${{ needs.start-gl0.outputs.peer_id }}"
          ML0_PEER_ID="${{ needs.start-ml0.outputs.peer_id }}"
          TOKEN_ID="${{ needs.start-ml0.outputs.token_id }}"
          
          # Start initial validators on node1
          ssh -i ~/.ssh/key root@$NODE1_IP "cd /opt/ottochain && \
            NODE_IP=$NODE1_IP \
            GL0_PEER_ID=$GL0_PEER_ID \
            ML0_PEER_ID=$ML0_PEER_ID \
            TOKEN_ID=$TOKEN_ID \
            CL_PASSWORD=${{ secrets.CL_KEYSTORE_PASSWORD }} \
            docker compose --profile genesis up -d cl1-initial dl1-initial"
          
          sleep 30
          
          CL1_PEER_ID=$(ssh -i ~/.ssh/key root@$NODE1_IP 'curl -sf http://localhost:9300/node/info | jq -r .id')
          DL1_PEER_ID=$(ssh -i ~/.ssh/key root@$NODE1_IP 'curl -sf http://localhost:9400/node/info | jq -r .id')
          
          # Start validators on node2, node3
          for ip in $NODE2_IP $NODE3_IP; do
            ssh -i ~/.ssh/key root@$ip "cd /opt/ottochain && \
              NODE_IP=$ip \
              GENESIS_IP=$NODE1_IP \
              GL0_PEER_ID=$GL0_PEER_ID \
              ML0_PEER_ID=$ML0_PEER_ID \
              TOKEN_ID=$TOKEN_ID \
              CL_PASSWORD=${{ secrets.CL_KEYSTORE_PASSWORD }} \
              docker compose --profile validator up -d cl1-validator dl1-validator"
          done
          
          sleep 25
          
          # Join CL1 validators
          for ip in $NODE2_IP $NODE3_IP; do
            ssh -i ~/.ssh/key root@$ip "docker exec cl1 curl -sf -X POST http://127.0.0.1:9302/cluster/join \
              -H 'Content-Type: application/json' \
              -d '{\"id\": \"$CL1_PEER_ID\", \"ip\": \"$NODE1_IP\", \"p2pPort\": 9301}'" || true
          done
          
          # Join DL1 validators
          for ip in $NODE2_IP $NODE3_IP; do
            ssh -i ~/.ssh/key root@$ip "docker exec dl1 curl -sf -X POST http://127.0.0.1:9402/cluster/join \
              -H 'Content-Type: application/json' \
              -d '{\"id\": \"$DL1_PEER_ID\", \"ip\": \"$NODE1_IP\", \"p2pPort\": 9401}'" || true
          done
          
          sleep 10
          
          echo "=== Cluster Status ==="
          echo "CL1: $(ssh -i ~/.ssh/key root@$NODE1_IP 'curl -sf http://localhost:9300/cluster/info | jq length') nodes"
          echo "DL1: $(ssh -i ~/.ssh/key root@$NODE1_IP 'curl -sf http://localhost:9400/cluster/info | jq length') nodes"

  # ============================================
  # HEALTH CHECK
  # ============================================
  health:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [start-l1]
    if: always()
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
          
      - name: Check all layers
        run: |
          echo "=== OttoChain 5-Layer Cluster Health ==="
          echo ""
          
          for layer in gl0 gl1 ml0 cl1 dl1; do
            case $layer in
              gl0) port=9000 ;;
              gl1) port=9100 ;;
              ml0) port=9200 ;;
              cl1) port=9300 ;;
              dl1) port=9400 ;;
            esac
            
            cluster=$(ssh -i ~/.ssh/key root@$NODE1_IP "curl -sf http://localhost:$port/cluster/info | jq length" || echo "0")
            state=$(ssh -i ~/.ssh/key root@$NODE1_IP "curl -sf http://localhost:$port/node/info | jq -r .state" || echo "DOWN")
            
            echo "$layer: $state (cluster: $cluster nodes)"
          done
          
      - name: Summary
        run: |
          echo "## ðŸš€ OttoChain Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Layer | Port | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|--------|" >> $GITHUB_STEP_SUMMARY
          
          for layer in GL0 GL1 ML0 CL1 DL1; do
            case $layer in
              GL0) port=9000 ;;
              GL1) port=9100 ;;
              ML0) port=9200 ;;
              CL1) port=9300 ;;
              DL1) port=9400 ;;
            esac
            cluster=$(ssh -i ~/.ssh/key root@$NODE1_IP "curl -sf http://localhost:$port/cluster/info | jq length" 2>/dev/null || echo "?")
            echo "| $layer | $port | $cluster nodes |" >> $GITHUB_STEP_SUMMARY
          done
