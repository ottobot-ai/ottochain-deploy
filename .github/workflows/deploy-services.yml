name: Deploy Services

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'scratch'
        type: choice
        options:
          - scratch
          - beta
          - staging
          - prod
      services_version:
        description: 'Services image version (default: latest)'
        required: false
        default: 'latest'
        type: string
      explorer_version:
        description: 'Explorer image version (default: latest)'
        required: false
        default: 'latest'
        type: string
      reset_db:
        description: 'Reset database and Redis'
        required: false
        default: false
        type: boolean
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      services_version:
        required: false
        type: string
        default: 'latest'
      explorer_version:
        required: false
        type: string
        default: 'latest'
      reset_db:
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    name: Deploy Services Stack
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/hetzner
          chmod 600 ~/.ssh/hetzner
          cat >> ~/.ssh/config << EOF
          Host services
            HostName ${{ secrets.HETZNER_SERVICES_IP }}
            User root
            IdentityFile ~/.ssh/hetzner
            StrictHostKeyChecking no
          
          Host node1
            HostName ${{ secrets.HETZNER_NODE1_IP }}
            User root
            IdentityFile ~/.ssh/hetzner
            StrictHostKeyChecking no
          EOF

      - name: Prepare remote directory
        run: |
          ssh services "mkdir -p /opt/ottochain-services"

      # Note: Database reset moved to after containers are started
      
      - name: Write docker-compose.yml
        run: |
          ssh services "cat > /opt/ottochain-services/docker-compose.yml" << 'COMPOSE_EOF'
          # OttoChain Services Stack
          # Auto-generated by deploy-services.yml - DO NOT EDIT ON SERVER
          
          services:
            gateway:
              image: ghcr.io/ottobot-ai/ottochain-services:${SERVICES_VERSION:-latest}
              container_name: gateway
              restart: unless-stopped
              ports:
                - "4000:4000"
              environment:
                - SERVICE=gateway
                - NODE_ENV=production
                - DATABASE_URL=${DATABASE_URL}
                - METAGRAPH_ML0_URL=${METAGRAPH_ML0_URL}
                - METAGRAPH_DL1_URL=${METAGRAPH_DL1_URL}
                - GL0_URL=${GL0_URL}
                - METAGRAPH_ID=${METAGRAPH_ID}
                - REDIS_URL=${REDIS_URL:-redis://redis:6379}
              depends_on:
                - redis
              networks:
                - ottochain
              healthcheck:
                test: ["CMD", "wget", "-q", "--spider", "http://localhost:4000/health"]
                interval: 30s
                timeout: 10s
                retries: 3

            bridge:
              image: ghcr.io/ottobot-ai/ottochain-services:${SERVICES_VERSION:-latest}
              container_name: bridge
              restart: unless-stopped
              ports:
                - "3030:3030"
              environment:
                - SERVICE=bridge
                - NODE_ENV=production
                - DATABASE_URL=${DATABASE_URL}
                - METAGRAPH_ML0_URL=${METAGRAPH_ML0_URL}
                - METAGRAPH_DL1_URL=${METAGRAPH_DL1_URL}
                - GL0_URL=${GL0_URL}
                - METAGRAPH_ID=${METAGRAPH_ID}
                - REDIS_URL=${REDIS_URL:-redis://redis:6379}
              depends_on:
                - redis
              networks:
                - ottochain
              healthcheck:
                test: ["CMD", "wget", "-q", "--spider", "http://localhost:3030/health"]
                interval: 30s
                timeout: 10s
                retries: 3

            indexer:
              image: ghcr.io/ottobot-ai/ottochain-services:${SERVICES_VERSION:-latest}
              container_name: indexer
              restart: unless-stopped
              ports:
                - "3031:3031"
              environment:
                - SERVICE=indexer
                - NODE_ENV=production
                - DATABASE_URL=${DATABASE_URL}
                - METAGRAPH_ML0_URL=${METAGRAPH_ML0_URL}
                - METAGRAPH_DL1_URL=${METAGRAPH_DL1_URL}
                - GL0_URL=${GL0_URL}
                - METAGRAPH_ID=${METAGRAPH_ID}
                - REDIS_URL=${REDIS_URL:-redis://redis:6379}
                - INDEXER_PORT=3031
                - INDEXER_CALLBACK_URL=${INDEXER_CALLBACK_URL:-http://indexer:3031/webhook/snapshot}
              depends_on:
                - postgres
                - redis
              networks:
                - ottochain
              healthcheck:
                test: ["CMD", "wget", "-q", "--spider", "http://localhost:3031/health"]
                interval: 30s
                timeout: 10s
                retries: 3

            monitor:
              image: ghcr.io/ottobot-ai/ottochain-services:${SERVICES_VERSION:-latest}
              container_name: monitor
              restart: unless-stopped
              ports:
                - "3032:3032"
              environment:
                - SERVICE=monitor
                - NODE_ENV=production
                - DATABASE_URL=${DATABASE_URL}
                - METAGRAPH_ML0_URL=${METAGRAPH_ML0_URL}
                - METAGRAPH_DL1_URL=${METAGRAPH_DL1_URL}
                - GL0_URL=${GL0_URL}
                - METAGRAPH_ID=${METAGRAPH_ID}
                - REDIS_URL=${REDIS_URL:-redis://redis:6379}
              depends_on:
                - redis
              networks:
                - ottochain
              healthcheck:
                test: ["CMD", "wget", "-q", "--spider", "http://localhost:3032/health"]
                interval: 30s
                timeout: 10s
                retries: 3

            traffic-gen:
              image: ghcr.io/ottobot-ai/ottochain-services:${SERVICES_VERSION:-latest}
              container_name: traffic-gen
              restart: unless-stopped
              environment:
                - SERVICE=traffic-generator
                - NODE_ENV=production
                - BRIDGE_URL=http://bridge:3030
                - METAGRAPH_ML0_URL=${METAGRAPH_ML0_URL}
                - ML0_URL=${METAGRAPH_ML0_URL}
                - GL0_URL=${GL0_URL}
                - INDEXER_URL=http://indexer:3031
                - TRAFFIC_INTERVAL=${TRAFFIC_INTERVAL:-5000}
                - TRAFFIC_BATCH_SIZE=${TRAFFIC_BATCH_SIZE:-3}
              depends_on:
                - bridge
                - indexer
              networks:
                - ottochain

            explorer:
              image: ghcr.io/ottobot-ai/ottochain-explorer:${EXPLORER_VERSION:-latest}
              container_name: explorer
              restart: unless-stopped
              ports:
                - "8081:80"
              networks:
                - ottochain
              healthcheck:
                test: ["CMD", "wget", "-q", "--spider", "http://localhost:80"]
                interval: 30s
                timeout: 10s
                retries: 3

            postgres:
              image: postgres:16-alpine
              container_name: postgres
              restart: unless-stopped
              ports:
                - "5432:5432"
              environment:
                - POSTGRES_USER=${POSTGRES_USER:-ottochain}
                - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-ottochain}
                - POSTGRES_DB=${POSTGRES_DB:-ottochain}
              volumes:
                - postgres_data:/var/lib/postgresql/data
              networks:
                - ottochain
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ottochain}"]
                interval: 10s
                timeout: 5s
                retries: 5

            redis:
              image: redis:7-alpine
              container_name: redis
              restart: unless-stopped
              ports:
                - "6379:6379"
              volumes:
                - redis_data:/data
              networks:
                - ottochain
              healthcheck:
                test: ["CMD", "redis-cli", "ping"]
                interval: 10s
                timeout: 5s
                retries: 5

          networks:
            ottochain:
              driver: bridge

          volumes:
            postgres_data:
            redis_data:
          COMPOSE_EOF

      - name: Write .env
        run: |
          METAGRAPH_IP="${{ secrets.HETZNER_NODE1_IP }}"
          SERVICES_VERSION="${{ inputs.services_version || 'latest' }}"
          EXPLORER_VERSION="${{ inputs.explorer_version || 'latest' }}"
          
          # Fetch metagraph ID from node1 (generated at metagraph build time)
          METAGRAPH_ID=$(ssh node1 "cat /opt/ottochain/genesis/genesis.address 2>/dev/null" || echo "")
          if [ -z "$METAGRAPH_ID" ]; then
            echo "âš ï¸ Could not fetch METAGRAPH_ID from node1, GL0 confirmations will be disabled"
          else
            echo "âœ“ Fetched METAGRAPH_ID: $METAGRAPH_ID"
          fi

          ssh services "cat > /opt/ottochain-services/.env" << ENVFILE
          # OttoChain Services Environment
          # Auto-generated by deploy-services.yml - DO NOT EDIT ON SERVER

          # Version pinning
          SERVICES_VERSION=${SERVICES_VERSION}
          EXPLORER_VERSION=${EXPLORER_VERSION}

          # Database
          DATABASE_URL=postgresql://ottochain:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/ottochain
          POSTGRES_USER=ottochain
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=ottochain

          # Redis (must be explicit - compose defaults don't always apply)
          REDIS_URL=redis://redis:6379

          # Metagraph identification (fetched from node1 genesis, used for GL0 confirmation checking)
          METAGRAPH_ID=${METAGRAPH_ID}

          # Metagraph endpoints
          METAGRAPH_ML0_URL=http://${METAGRAPH_IP}:9200
          METAGRAPH_DL1_URL=http://${METAGRAPH_IP}:9400
          GL0_URL=http://${METAGRAPH_IP}:9000
          GL1_URL=http://${METAGRAPH_IP}:9100
          ML0_URL=http://${METAGRAPH_IP}:9200
          CL1_URL=http://${METAGRAPH_IP}:9300
          DL1_URL=http://${METAGRAPH_IP}:9400

          # Alerting
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }}
          ENVFILE

      - name: Deploy stack
        run: |
          ssh services << 'DEPLOY_SCRIPT'
          cd /opt/ottochain-services
          
          # Stop PM2 if running (migration from old setup)
          pm2 stop all 2>/dev/null || true
          pm2 delete all 2>/dev/null || true
          
          # Clean up any orphan containers from previous runs/projects
          # This handles containers that compose down won't remove
          docker rm -f gateway bridge indexer explorer postgres redis 2>/dev/null || true
          
          # Pull images and deploy
          # IMPORTANT: --force-recreate ensures containers pick up new .env values
          docker compose pull
          docker compose down --remove-orphans 2>/dev/null || true
          docker compose up -d --force-recreate
          
          # Wait for postgres/redis to be ready
          sleep 10
          DEPLOY_SCRIPT

      - name: Reset database and Redis
        if: ${{ inputs.reset_db == true }}
        run: |
          echo "Resetting database and Redis (wipe_state requested)..."
          ssh services << 'RESET_SCRIPT'
          # Flush Redis
          docker exec redis redis-cli FLUSHALL && echo "âœ“ Redis flushed"
          
          # Truncate all Postgres tables
          docker exec postgres psql -U ottochain -d ottochain -c "
            DO \$\$
            DECLARE
              r RECORD;
            BEGIN
              FOR r IN (SELECT tablename FROM pg_tables WHERE schemaname = 'public') LOOP
                EXECUTE 'TRUNCATE TABLE \"' || r.tablename || '\" CASCADE';
              END LOOP;
            END \$\$;
          " && echo "âœ“ Postgres tables truncated"
          RESET_SCRIPT
          
      - name: Run migrations and restart services
        run: |
          ssh services << 'MIGRATE_SCRIPT'
          cd /opt/ottochain-services
          
          # Run database migrations
          docker compose exec -T indexer npx prisma db push --accept-data-loss || true
          
          # Restart services to pick up clean state
          docker compose restart gateway bridge indexer monitor || true
          
          # Show status
          docker compose ps
          
          echo "âœ“ Services deployed and ready"
          MIGRATE_SCRIPT

      - name: Update nginx config
        run: |
          ssh services << 'NGINX_SCRIPT'
          cat > /etc/nginx/sites-available/ottochain << 'NGINX_CONF'
          server {
              listen 8080;
              server_name _;

              location /graphql {
                  proxy_pass http://127.0.0.1:4000/graphql;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
              }

              location /api/ {
                  proxy_pass http://127.0.0.1:3030/;
              }

              location /webhook/ {
                  proxy_pass http://127.0.0.1:3031/;
              }

              location /monitor/ {
                  proxy_pass http://127.0.0.1:3032/;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
              }

              location / {
                  proxy_pass http://127.0.0.1:8081;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
              }
          }
          NGINX_CONF
          
          ln -sf /etc/nginx/sites-available/ottochain /etc/nginx/sites-enabled/ottochain
          nginx -t && nginx -s reload
          NGINX_SCRIPT

      - name: Health check
        run: |
          echo "Waiting for services to start..."
          sleep 15
          
          echo "Checking services health..."
          for service in gateway bridge indexer monitor; do
            case $service in
              gateway) port=4000 ;; bridge) port=3030 ;; indexer) port=3031 ;; monitor) port=3032 ;;
            esac
            status=$(ssh services "curl -sf -o /dev/null -w '%{http_code}' http://localhost:$port/health" || echo "000")
            if [ "$status" = "200" ]; then
              echo "âœ… $service: healthy"
            else
              echo "âš ï¸ $service: HTTP $status"
            fi
          done
          
          # Check explorer
          explorer=$(ssh services "curl -sf -o /dev/null -w '%{http_code}' http://localhost:8081" || echo "000")
          if [ "$explorer" = "200" ]; then
            echo "âœ… explorer: healthy"
          else
            echo "âš ï¸ explorer: HTTP $explorer"
          fi

      - name: Summary
        run: |
          echo "## ðŸš€ Services Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Port | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|--------|" >> $GITHUB_STEP_SUMMARY
          
          for service in gateway bridge indexer monitor explorer; do
            case $service in
              gateway) port=4000 ;; bridge) port=3030 ;; indexer) port=3031 ;; monitor) port=3032 ;; explorer) port=8081 ;;
            esac
            status=$(ssh services "curl -sf -o /dev/null -w '%{http_code}' http://localhost:$port/health 2>/dev/null || curl -sf -o /dev/null -w '%{http_code}' http://localhost:$port" || echo "000")
            ICON="âœ…"; [ "$status" != "200" ] && ICON="âš ï¸"
            echo "| $ICON $service | $port | HTTP $status |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services Version**: \`${{ inputs.services_version || 'latest' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Explorer Version**: \`${{ inputs.explorer_version || 'latest' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Explorer**: http://${{ secrets.HETZNER_SERVICES_IP }}:8080" >> $GITHUB_STEP_SUMMARY
