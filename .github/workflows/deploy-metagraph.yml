name: Deploy Metagraph

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'scratch'
        type: choice
        options:
          - scratch
          - beta
          - staging
          - prod
      wipe_state:
        description: 'Wipe all state (genesis reset)'
        required: true
        default: 'false'
        type: boolean
      image_tag:
        description: 'Docker image tag (default: latest)'
        required: false
        default: 'latest'
        type: string
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      wipe_state:
        required: false
        type: boolean
        default: false
      image_tag:
        required: false
        type: string
        default: 'latest'

env:
  # Single image with all 5 layers (tessellation + metagraph)
  # Ensures version compatibility
  IMAGE: ghcr.io/scasplte2/ottochain-metagraph
  IMAGE_TAG: ${{ inputs.image_tag || 'latest' }}

jobs:
  deploy:
    name: Deploy Full Stack
    runs-on: ubuntu-latest
    outputs:
      gl0_peer_id: ${{ steps.start-gl0.outputs.gl0_peer_id }}
      ml0_peer_id: ${{ steps.start-ml0.outputs.ml0_peer_id }}
      token_id: ${{ steps.start-ml0.outputs.token_id }}

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/hetzner
          chmod 600 ~/.ssh/hetzner

          for host in node1 node2 node3; do
            case $host in
              node1) ip="${{ secrets.HETZNER_NODE1_IP }}" ;;
              node2) ip="${{ secrets.HETZNER_NODE2_IP }}" ;;
              node3) ip="${{ secrets.HETZNER_NODE3_IP }}" ;;
            esac
            cat >> ~/.ssh/config << EOF
          Host $host
            HostName $ip
            User root
            IdentityFile ~/.ssh/hetzner
            StrictHostKeyChecking no
          EOF
          done

      - name: Login to GHCR on all nodes
        run: |
          for host in node1 node2 node3; do
            ssh $host "echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u ottobot-ai --password-stdin" &
          done
          wait
          echo "âœ… GHCR login complete on all nodes"

      - name: Pull image on all nodes
        run: |
          for host in node1 node2 node3; do
            echo "Pulling image on $host..."
            ssh $host "docker pull ${{ env.IMAGE }}:${{ env.IMAGE_TAG }}" &
          done
          wait
          echo "âœ… Image pulled on all nodes"

      - name: Stop all containers
        run: |
          for host in node1 node2 node3; do
            # Also stop node-exporter which uses port 9100 (conflicts with GL1)
            ssh $host 'docker rm -f gl0 gl1 ml0 cl1 dl1 node-exporter 2>/dev/null || true' &
          done
          wait

      - name: Setup and verify keys on all nodes
        run: |
          echo "=== Setting up L1 consensus keys ==="
          # L1 nodes need DIFFERENT keys for consensus - same key = same peer ID = no consensus
          # Node1 stores the master keys (key.p12, key2.p12, key3.p12)
          # Node2 uses keys2/key.p12, Node3 uses keys3/key.p12
          
          # Verify node1 has the source keys
          ssh node1 'test -f /opt/ottochain/keys/key.p12 || (echo "ERROR: key.p12 not found on node1"; exit 1)'
          echo "âœ“ node1: source key.p12 exists"
          
          # Distribute key2.p12 to node2 if missing
          if ! ssh node2 'test -f /opt/ottochain/keys2/key.p12' 2>/dev/null; then
            echo "Distributing key2 to node2..."
            ssh node2 'mkdir -p /opt/ottochain/keys2'
            if ssh node1 'test -f /opt/ottochain/keys/key2.p12'; then
              ssh node1 'cat /opt/ottochain/keys/key2.p12' | ssh node2 'cat > /opt/ottochain/keys2/key.p12 && chmod 644 /opt/ottochain/keys2/key.p12'
              echo "âœ“ Copied key2.p12 from node1 to node2/keys2/"
            else
              echo "ERROR: key2.p12 not found on node1 - cannot setup node2"
              exit 1
            fi
          else
            echo "âœ“ node2: keys2/key.p12 already exists"
          fi
          
          # Distribute key3.p12 to node3 if missing
          if ! ssh node3 'test -f /opt/ottochain/keys3/key.p12' 2>/dev/null; then
            echo "Distributing key3 to node3..."
            ssh node3 'mkdir -p /opt/ottochain/keys3'
            if ssh node1 'test -f /opt/ottochain/keys/key3.p12'; then
              ssh node1 'cat /opt/ottochain/keys/key3.p12' | ssh node3 'cat > /opt/ottochain/keys3/key.p12 && chmod 644 /opt/ottochain/keys3/key.p12'
              echo "âœ“ Copied key3.p12 from node1 to node3/keys3/"
            else
              echo "ERROR: key3.p12 not found on node1 - cannot setup node3"
              exit 1
            fi
          else
            echo "âœ“ node3: keys3/key.p12 already exists"
          fi
          
          echo ""
          echo "All keys verified. L1 consensus should work."

      - name: Detect if genesis is needed
        id: genesis-check
        run: |
          # Genesis is required if:
          # 1. wipe_state is explicitly true, OR
          # 2. genesis.address doesn't exist (fresh deploy / no prior genesis)
          WIPE="${{ inputs.wipe_state }}"
          if [ "$WIPE" = "true" ]; then
            echo "needs_genesis=true" >> $GITHUB_OUTPUT
            echo "Genesis required: wipe_state=true"
          elif ! ssh node1 'test -f /opt/ottochain/genesis/genesis.address' 2>/dev/null; then
            echo "needs_genesis=true" >> $GITHUB_OUTPUT
            echo "Genesis required: genesis.address not found"
          else
            echo "needs_genesis=false" >> $GITHUB_OUTPUT
            echo "Genesis not required: existing genesis.address found"
            ssh node1 'cat /opt/ottochain/genesis/genesis.address'
          fi

      - name: Wipe state
        if: ${{ inputs.wipe_state == true }}
        run: |
          # Only wipe when explicitly requested (not just because genesis is missing)
          for host in node1 node2 node3; do
            ssh $host 'rm -rf /opt/ottochain/data/* /opt/ottochain/genesis/*'
            ssh $host 'mkdir -p /opt/ottochain/{data,keys,genesis}'
          done

      - name: Prepare directories
        run: |
          for host in node1 node2 node3; do
            ssh $host 'mkdir -p /opt/ottochain/{data,keys,genesis}'
          done

      # NOTE: In tessellation v4.x:
      # - GL0 run-genesis requires a genesis CSV file with initial balances
      # - ML0 create-genesis requires GL0 to be running
      
      - name: Create GL0 genesis file
        if: ${{ steps.genesis-check.outputs.needs_genesis == 'true' }}
        run: |
          # Download cl-wallet.jar for wallet address extraction
          ssh node1 "test -f /opt/ottochain/cl-wallet.jar || curl -sL -o /opt/ottochain/cl-wallet.jar \
            https://github.com/Constellation-Labs/tessellation/releases/download/v4.0.0-rc.2/cl-wallet.jar"
          
          # Get wallet address
          WALLET=$(ssh node1 "CL_KEYSTORE=/opt/ottochain/keys/key.p12 CL_KEYALIAS=alias CL_PASSWORD='${{ secrets.CL_KEYSTORE_PASSWORD }}' \
            java -jar /opt/ottochain/cl-wallet.jar show-address" 2>&1 | grep -oP 'DAG[a-zA-Z0-9]+' | head -1)
          
          echo "GL0 genesis wallet: $WALLET"
          
          # Create genesis.csv for GL0 (DAG initial balances)
          ssh node1 "echo '${WALLET},1000000000000000' > /opt/ottochain/genesis/gl0-genesis.csv"
          ssh node1 "cat /opt/ottochain/genesis/gl0-genesis.csv"
          echo "âœ… GL0 genesis file created"

      - name: Start GL0 Genesis
        id: start-gl0
        run: |
          NODE1_IP="${{ secrets.HETZNER_NODE1_IP }}"
          
          # In v4.x, run-genesis requires the genesis CSV as a positional argument
          # We bypass the entrypoint and run the JAR directly with proper args
          ssh node1 "docker run -d --name gl0 \
            --restart unless-stopped \
            --entrypoint '' \
            -p 9000:9000 -p 9001:9001 -p 9002:9002 \
            -v /opt/ottochain/keys:/ottochain/keys:ro \
            -v /opt/ottochain/data:/ottochain/data \
            -v /opt/ottochain/genesis:/ottochain/genesis:ro \
            -e CL_KEYSTORE=/ottochain/keys/key.p12 \
            -e CL_KEYALIAS=alias \
            -e CL_PASSWORD='${{ secrets.CL_KEYSTORE_PASSWORD }}' \
            ${{ env.IMAGE }}:${{ env.IMAGE_TAG }} \
            java -Xmx8g -Xms4g -jar /ottochain/jars/gl0.jar run-genesis \
              --env dev \
              --ip ${NODE1_IP} \
              --public-port 9000 \
              --p2p-port 9001 \
              --cli-port 9002 \
              --collateral 0 \
              /ottochain/genesis/gl0-genesis.csv"

          echo "Waiting for GL0 to become Ready..."
          for i in $(seq 1 90); do
            state=$(ssh node1 'curl -sf http://localhost:9000/node/info | jq -r .state' || echo "")
            if [ "$state" = "Ready" ]; then
              echo "GL0 Ready after $((i*5))s"
              break
            fi
            if [ "$i" = "90" ]; then echo "::error::GL0 failed to reach Ready"; exit 1; fi
            sleep 5
          done

          GL0_PEER_ID=$(ssh node1 'curl -sf http://localhost:9000/node/info | jq -r .id')
          echo "gl0_peer_id=$GL0_PEER_ID" >> "$GITHUB_OUTPUT"
          echo "GL0 Peer ID: $GL0_PEER_ID"

      - name: Start GL0 Validators
        run: |
          NODE1_IP="${{ secrets.HETZNER_NODE1_IP }}"
          NODE2_IP="${{ secrets.HETZNER_NODE2_IP }}"
          NODE3_IP="${{ secrets.HETZNER_NODE3_IP }}"
          GL0_PEER_ID="${{ steps.start-gl0.outputs.gl0_peer_id }}"

          for host_info in "node2:${NODE2_IP}" "node3:${NODE3_IP}"; do
            HOST="${host_info%%:*}"
            IP="${host_info##*:}"

            ssh $HOST << EOF
          docker run -d --name gl0 \
            --restart unless-stopped \
            -p 9000:9000 -p 9001:9001 -p 9002:9002 \
            -v /opt/ottochain/keys:/ottochain/keys:ro \
            -v /opt/ottochain/data:/ottochain/data \
            -e LAYER=gl0 \
            -e RUN_MODE=run-validator \
            -e CL_APP_ENV=dev \
            -e CL_EXTERNAL_IP=${IP} \
            -e CL_COLLATERAL=0 \
            -e CL_PASSWORD=${{ secrets.CL_KEYSTORE_PASSWORD }} \
            -e JAVA_OPTS="-Xmx8g -Xms4g" \
            ${{ env.IMAGE }}:${{ env.IMAGE_TAG }}
          EOF
          done

          sleep 20

          # CLI port binds to container's 127.0.0.1, must use docker exec
          for host in node2 node3; do
            ssh $host "docker exec gl0 curl -sf -X POST http://127.0.0.1:9002/cluster/join \
              -H 'Content-Type: application/json' \
              -d '{\"id\": \"${GL0_PEER_ID}\", \"ip\": \"${NODE1_IP}\", \"p2pPort\": 9001}'" || true
          done

          sleep 15
          echo "GL0 cluster size: $(ssh node1 'curl -sf http://localhost:9000/cluster/info | jq length')"

      - name: Start GL1
        run: |
          NODE1_IP="${{ secrets.HETZNER_NODE1_IP }}"
          NODE2_IP="${{ secrets.HETZNER_NODE2_IP }}"
          NODE3_IP="${{ secrets.HETZNER_NODE3_IP }}"
          GL0_PEER_ID="${{ steps.start-gl0.outputs.gl0_peer_id }}"

          ssh node1 << EOF
          docker run -d --name gl1 \
            --restart unless-stopped \
            -p 9100:9100 -p 9101:9101 -p 9102:9102 \
            -v /opt/ottochain/keys:/ottochain/keys:ro \
            -v /opt/ottochain/data:/ottochain/data \
            -e LAYER=gl1 \
            -e RUN_MODE=run-initial-validator \
            -e CL_APP_ENV=dev \
            -e CL_EXTERNAL_IP=${NODE1_IP} \
            -e CL_COLLATERAL=0 \
            -e CL_L0_PEER_ID=${GL0_PEER_ID} \
            -e CL_L0_PEER_HOST=${NODE1_IP} \
            -e CL_L0_PEER_PORT=9000 \
            -e CL_PASSWORD=${{ secrets.CL_KEYSTORE_PASSWORD }} \
            -e JAVA_OPTS="-Xmx4g -Xms2g" \
            ${{ env.IMAGE }}:${{ env.IMAGE_TAG }}
          EOF

          for i in $(seq 1 60); do
            state=$(ssh node1 'curl -sf http://localhost:9100/node/info | jq -r .state' || echo "")
            if [ "$state" = "Ready" ]; then break; fi
            sleep 5
          done

          GL1_PEER_ID=$(ssh node1 'curl -sf http://localhost:9100/node/info | jq -r .id' || echo "")

          for host_info in "node2:${NODE2_IP}" "node3:${NODE3_IP}"; do
            HOST="${host_info%%:*}"
            IP="${host_info##*:}"
            ssh $HOST << EOF
          docker run -d --name gl1 \
            --restart unless-stopped \
            -p 9100:9100 -p 9101:9101 -p 9102:9102 \
            -v /opt/ottochain/keys:/ottochain/keys:ro \
            -v /opt/ottochain/data:/ottochain/data \
            -e LAYER=gl1 \
            -e RUN_MODE=run-validator \
            -e CL_APP_ENV=dev \
            -e CL_EXTERNAL_IP=${IP} \
            -e CL_COLLATERAL=0 \
            -e CL_L0_PEER_ID=${GL0_PEER_ID} \
            -e CL_L0_PEER_HOST=${NODE1_IP} \
            -e CL_L0_PEER_PORT=9000 \
            -e CL_PASSWORD=${{ secrets.CL_KEYSTORE_PASSWORD }} \
            -e JAVA_OPTS="-Xmx4g -Xms2g" \
            ${{ env.IMAGE }}:${{ env.IMAGE_TAG }}
          EOF
          done

          sleep 20

          if [ -n "$GL1_PEER_ID" ] && [ "$GL1_PEER_ID" != "null" ]; then
            for host in node2 node3; do
              ssh $host "docker exec gl1 curl -sf -X POST http://127.0.0.1:9102/cluster/join \
                -H 'Content-Type: application/json' \
                -d '{\"id\": \"${GL1_PEER_ID}\", \"ip\": \"${NODE1_IP}\", \"p2pPort\": 9101}'" || true
            done
          fi

      # In tessellation v4.x, create-genesis requires GL0 to be running
      - name: Create ML0 genesis snapshot
        if: ${{ steps.genesis-check.outputs.needs_genesis == 'true' }}
        run: |
          NODE1_IP="${{ secrets.HETZNER_NODE1_IP }}"
          GL0_PEER_ID="${{ steps.start-gl0.outputs.gl0_peer_id }}"

          # Download tessellation cl-wallet.jar v4.x if not present (has show-address/show-id commands)
          ssh node1 "test -f /opt/ottochain/cl-wallet.jar || curl -sL -o /opt/ottochain/cl-wallet.jar \
            https://github.com/Constellation-Labs/tessellation/releases/download/v4.0.0-rc.2/cl-wallet.jar"

          # Get wallet address from keystore using cl-wallet
          echo "Getting wallet address..."
          WALLET=$(ssh node1 "CL_KEYSTORE=/opt/ottochain/keys/key.p12 CL_KEYALIAS=alias CL_PASSWORD='${{ secrets.CL_KEYSTORE_PASSWORD }}' \
            java -jar /opt/ottochain/cl-wallet.jar show-address" 2>&1 | grep -oP 'DAG[a-zA-Z0-9]+' | head -1)

          if [ -z "$WALLET" ]; then
            echo "âŒ Failed to get wallet address"
            exit 1
          fi
          echo "Wallet address: $WALLET"

          # Create genesis.csv with initial token allocation
          ssh node1 "echo '${WALLET},1000000000000000' > /opt/ottochain/genesis/genesis.csv"
          echo "Genesis CSV:"
          ssh node1 "cat /opt/ottochain/genesis/genesis.csv"

          # Run create-genesis with GL0 running (required in tessellation v4.x)
          # The command connects to GL0 to fetch the current global snapshot
          echo "Creating genesis snapshot (GL0 must be running)..."
          ssh node1 "docker run --rm \
            --network host \
            --entrypoint '' \
            -v /opt/ottochain/keys:/ottochain/keys:ro \
            -v /opt/ottochain/genesis:/ottochain/genesis \
            -w /ottochain/genesis \
            -e CL_KEYSTORE=/ottochain/keys/key.p12 \
            -e CL_KEYALIAS=alias \
            -e CL_PASSWORD='${{ secrets.CL_KEYSTORE_PASSWORD }}' \
            -e CL_GLOBAL_L0_PEER_ID=${GL0_PEER_ID} \
            -e CL_GLOBAL_L0_PEER_HTTP_HOST=${NODE1_IP} \
            -e CL_GLOBAL_L0_PEER_HTTP_PORT=9000 \
            -e CL_PUBLIC_HTTP_PORT=9200 \
            -e CL_P2P_HTTP_PORT=9201 \
            -e CL_CLI_HTTP_PORT=9202 \
            -e CL_COLLATERAL=0 \
            -e CL_APP_ENV=dev \
            -e CL_EXTERNAL_IP=${NODE1_IP} \
            ${{ env.IMAGE }}:${{ env.IMAGE_TAG }} \
            java -jar /ottochain/jars/ml0.jar create-genesis /ottochain/genesis/genesis.csv"

          # Verify genesis was created
          ssh node1 "ls -la /opt/ottochain/genesis/"
          echo "âœ… ML0 genesis snapshot created"

      - name: Start ML0
        id: start-ml0
        run: |
          NODE1_IP="${{ secrets.HETZNER_NODE1_IP }}"
          NODE2_IP="${{ secrets.HETZNER_NODE2_IP }}"
          NODE3_IP="${{ secrets.HETZNER_NODE3_IP }}"
          GL0_PEER_ID="${{ steps.start-gl0.outputs.gl0_peer_id }}"

          # In tessellation v4.x:
          # 1. run-genesis requires genesis snapshot as positional argument
          # 2. ALL config must be via env vars (CLI flags alone are not enough)
          # Bypass entrypoint and run JAR directly with full env var config
          if [ "${{ steps.genesis-check.outputs.needs_genesis }}" = "true" ]; then
            ssh node1 "docker run -d --name ml0 \
              --restart unless-stopped \
              --entrypoint '' \
              -p 9200:9200 -p 9201:9201 -p 9202:9202 \
              -v /opt/ottochain/keys:/ottochain/keys:ro \
              -v /opt/ottochain/data:/ottochain/data \
              -v /opt/ottochain/genesis:/ottochain/genesis:ro \
              -e CL_KEYSTORE=/ottochain/keys/key.p12 \
              -e CL_KEYALIAS=alias \
              -e CL_PASSWORD='${{ secrets.CL_KEYSTORE_PASSWORD }}' \
              -e CL_APP_ENV=dev \
              -e CL_PUBLIC_HTTP_PORT=9200 \
              -e CL_P2P_HTTP_PORT=9201 \
              -e CL_CLI_HTTP_PORT=9202 \
              -e CL_EXTERNAL_IP=${NODE1_IP} \
              -e CL_COLLATERAL=0 \
              -e CL_GLOBAL_L0_PEER_ID=${GL0_PEER_ID} \
              -e CL_GLOBAL_L0_PEER_HTTP_HOST=${NODE1_IP} \
              -e CL_GLOBAL_L0_PEER_HTTP_PORT=9000 \
              ${{ env.IMAGE }}:${{ env.IMAGE_TAG }} \
              java -Xmx8g -Xms4g -jar /ottochain/jars/ml0.jar run-genesis \
                /ottochain/genesis/genesis.snapshot"
          else
            ssh node1 << EOF
          docker run -d --name ml0 \
            --restart unless-stopped \
            -p 9200:9200 -p 9201:9201 -p 9202:9202 \
            -v /opt/ottochain/keys:/ottochain/keys:ro \
            -v /opt/ottochain/data:/ottochain/data \
            -e LAYER=ml0 \
            -e RUN_MODE=run-validator \
            -e CL_APP_ENV=dev \
            -e CL_EXTERNAL_IP=${NODE1_IP} \
            -e CL_COLLATERAL=0 \
            -e CL_GLOBAL_L0_PEER_ID=${GL0_PEER_ID} \
            -e CL_GLOBAL_L0_PEER_HOST=${NODE1_IP} \
            -e CL_GLOBAL_L0_PEER_PORT=9000 \
            -e CL_PASSWORD=${{ secrets.CL_KEYSTORE_PASSWORD }} \
            -e JAVA_OPTS="-Xmx8g -Xms4g" \
            ${{ env.IMAGE }}:${{ env.IMAGE_TAG }}
          EOF
          fi

          echo "Waiting for ML0 to become Ready..."
          for i in $(seq 1 90); do
            state=$(ssh node1 'curl -sf http://localhost:9200/node/info | jq -r .state' || echo "")
            if [ "$state" = "Ready" ]; then
              echo "ML0 Ready after $((i*5))s"
              break
            fi
            if [ "$i" = "90" ]; then echo "::error::ML0 failed to reach Ready"; exit 1; fi
            sleep 5
          done

          ML0_PEER_ID=$(ssh node1 'curl -sf http://localhost:9200/node/info | jq -r .id')
          echo "ml0_peer_id=$ML0_PEER_ID" >> "$GITHUB_OUTPUT"

          # v4.x doesn't expose .address in /node/info, read from genesis file
          TOKEN_ID=$(ssh node1 'cat /opt/ottochain/genesis/genesis.address')
          echo "token_id=$TOKEN_ID" >> "$GITHUB_OUTPUT"
          echo "Token ID: $TOKEN_ID"
          
          for host_info in "node2:${NODE2_IP}" "node3:${NODE3_IP}"; do
            HOST="${host_info%%:*}"
            IP="${host_info##*:}"
            ssh $HOST "docker run -d --name ml0 \
              --restart unless-stopped \
              --entrypoint '' \
              -p 9200:9200 -p 9201:9201 -p 9202:9202 \
              -v /opt/ottochain/keys:/ottochain/keys:ro \
              -v /opt/ottochain/data:/ottochain/data \
              -e CL_KEYSTORE=/ottochain/keys/key.p12 \
              -e CL_KEYALIAS=alias \
              -e CL_PASSWORD='${{ secrets.CL_KEYSTORE_PASSWORD }}' \
              -e CL_APP_ENV=dev \
              -e CL_PUBLIC_HTTP_PORT=9200 \
              -e CL_P2P_HTTP_PORT=9201 \
              -e CL_CLI_HTTP_PORT=9202 \
              -e CL_EXTERNAL_IP=${IP} \
              -e CL_COLLATERAL=0 \
              -e CL_GLOBAL_L0_PEER_ID=${GL0_PEER_ID} \
              -e CL_GLOBAL_L0_PEER_HTTP_HOST=${NODE1_IP} \
              -e CL_GLOBAL_L0_PEER_HTTP_PORT=9000 \
              -e CL_L0_TOKEN_IDENTIFIER=${TOKEN_ID} \
              ${{ env.IMAGE }}:${{ env.IMAGE_TAG }} \
              java -Xmx8g -Xms4g -jar /ottochain/jars/ml0.jar run-validator"
          done

          sleep 25

          for host in node2 node3; do
            ssh $host "docker exec ml0 curl -sf -X POST http://127.0.0.1:9202/cluster/join \
              -H 'Content-Type: application/json' \
              -d '{\"id\": \"${ML0_PEER_ID}\", \"ip\": \"${NODE1_IP}\", \"p2pPort\": 9201}'" || true
          done

      - name: Start CL1
        run: |
          NODE1_IP="${{ secrets.HETZNER_NODE1_IP }}"
          NODE2_IP="${{ secrets.HETZNER_NODE2_IP }}"
          NODE3_IP="${{ secrets.HETZNER_NODE3_IP }}"
          GL0_PEER_ID="${{ steps.start-gl0.outputs.gl0_peer_id }}"
          ML0_PEER_ID="${{ steps.start-ml0.outputs.ml0_peer_id }}"
          TOKEN_ID=$(ssh node1 'cat /opt/ottochain/genesis/genesis.address')
          echo "Token ID: $TOKEN_ID"

          # v4.x requires _HTTP_ suffix for peer env vars and all port config via env
          ssh node1 "docker run -d --name cl1 \
            --restart unless-stopped \
            --entrypoint '' \
            -p 9300:9300 -p 9301:9301 -p 9302:9302 \
            -v /opt/ottochain/keys:/ottochain/keys:ro \
            -v /opt/ottochain/data:/ottochain/data \
            -e CL_KEYSTORE=/ottochain/keys/key.p12 \
            -e CL_KEYALIAS=alias \
            -e CL_PASSWORD='${{ secrets.CL_KEYSTORE_PASSWORD }}' \
            -e CL_APP_ENV=dev \
            -e CL_PUBLIC_HTTP_PORT=9300 \
            -e CL_P2P_HTTP_PORT=9301 \
            -e CL_CLI_HTTP_PORT=9302 \
            -e CL_EXTERNAL_IP=${NODE1_IP} \
            -e CL_COLLATERAL=0 \
            -e CL_GLOBAL_L0_PEER_ID=${GL0_PEER_ID} \
            -e CL_GLOBAL_L0_PEER_HTTP_HOST=${NODE1_IP} \
            -e CL_GLOBAL_L0_PEER_HTTP_PORT=9000 \
            -e CL_L0_PEER_ID=${ML0_PEER_ID} \
            -e CL_L0_PEER_HTTP_HOST=${NODE1_IP} \
            -e CL_L0_PEER_HTTP_PORT=9200 \
            -e CL_L0_TOKEN_IDENTIFIER=${TOKEN_ID} \
            ${{ env.IMAGE }}:${{ env.IMAGE_TAG }} \
            java -Xmx4g -Xms2g -jar /ottochain/jars/cl1.jar run-initial-validator"

          for i in $(seq 1 60); do
            state=$(ssh node1 'curl -sf http://localhost:9300/node/info | jq -r .state' || echo "")
            if [ "$state" = "Ready" ]; then break; fi
            sleep 5
          done

          CL1_PEER_ID=$(ssh node1 'curl -sf http://localhost:9300/node/info | jq -r .id' || echo "")

          # CRITICAL: Each L1 node needs a DIFFERENT key for consensus
          # node2 uses keys2, node3 uses keys3
          for host_info in "node2:${NODE2_IP}:keys2" "node3:${NODE3_IP}:keys3"; do
            HOST="${host_info%%:*}"
            rest="${host_info#*:}"
            IP="${rest%%:*}"
            KEYS="${rest##*:}"
            ssh $HOST "docker run -d --name cl1 \
              --restart unless-stopped \
              --entrypoint '' \
              -p 9300:9300 -p 9301:9301 -p 9302:9302 \
              -v /opt/ottochain/${KEYS}:/ottochain/keys:ro \
              -v /opt/ottochain/data:/ottochain/data \
              -e CL_KEYSTORE=/ottochain/keys/key.p12 \
              -e CL_KEYALIAS=alias \
              -e CL_PASSWORD='${{ secrets.CL_KEYSTORE_PASSWORD }}' \
              -e CL_APP_ENV=dev \
              -e CL_PUBLIC_HTTP_PORT=9300 \
              -e CL_P2P_HTTP_PORT=9301 \
              -e CL_CLI_HTTP_PORT=9302 \
              -e CL_EXTERNAL_IP=${IP} \
              -e CL_COLLATERAL=0 \
              -e CL_GLOBAL_L0_PEER_ID=${GL0_PEER_ID} \
              -e CL_GLOBAL_L0_PEER_HTTP_HOST=${NODE1_IP} \
              -e CL_GLOBAL_L0_PEER_HTTP_PORT=9000 \
              -e CL_L0_PEER_ID=${ML0_PEER_ID} \
              -e CL_L0_PEER_HTTP_HOST=${NODE1_IP} \
              -e CL_L0_PEER_HTTP_PORT=9200 \
              -e CL_L0_TOKEN_IDENTIFIER=${TOKEN_ID} \
              ${{ env.IMAGE }}:${{ env.IMAGE_TAG }} \
              java -Xmx4g -Xms2g -jar /ottochain/jars/cl1.jar run-validator"
          done

          sleep 25

          if [ -n "$CL1_PEER_ID" ] && [ "$CL1_PEER_ID" != "null" ]; then
            for host in node2 node3; do
              ssh $host "docker exec cl1 curl -sf -X POST http://127.0.0.1:9302/cluster/join \
                -H 'Content-Type: application/json' \
                -d '{\"id\": \"${CL1_PEER_ID}\", \"ip\": \"${NODE1_IP}\", \"p2pPort\": 9301}'" || true
            done
          fi

      - name: Start DL1
        run: |
          NODE1_IP="${{ secrets.HETZNER_NODE1_IP }}"
          NODE2_IP="${{ secrets.HETZNER_NODE2_IP }}"
          NODE3_IP="${{ secrets.HETZNER_NODE3_IP }}"
          GL0_PEER_ID="${{ steps.start-gl0.outputs.gl0_peer_id }}"
          ML0_PEER_ID="${{ steps.start-ml0.outputs.ml0_peer_id }}"
          TOKEN_ID=$(ssh node1 'cat /opt/ottochain/genesis/genesis.address')

          # v4.x requires _HTTP_ suffix for peer env vars and all port config via env
          ssh node1 "docker run -d --name dl1 \
            --restart unless-stopped \
            --entrypoint '' \
            -p 9400:9400 -p 9401:9401 -p 9402:9402 \
            -v /opt/ottochain/keys:/ottochain/keys:ro \
            -v /opt/ottochain/data:/ottochain/data \
            -e CL_KEYSTORE=/ottochain/keys/key.p12 \
            -e CL_KEYALIAS=alias \
            -e CL_PASSWORD='${{ secrets.CL_KEYSTORE_PASSWORD }}' \
            -e CL_APP_ENV=dev \
            -e CL_PUBLIC_HTTP_PORT=9400 \
            -e CL_P2P_HTTP_PORT=9401 \
            -e CL_CLI_HTTP_PORT=9402 \
            -e CL_EXTERNAL_IP=${NODE1_IP} \
            -e CL_COLLATERAL=0 \
            -e CL_GLOBAL_L0_PEER_ID=${GL0_PEER_ID} \
            -e CL_GLOBAL_L0_PEER_HTTP_HOST=${NODE1_IP} \
            -e CL_GLOBAL_L0_PEER_HTTP_PORT=9000 \
            -e CL_L0_PEER_ID=${ML0_PEER_ID} \
            -e CL_L0_PEER_HTTP_HOST=${NODE1_IP} \
            -e CL_L0_PEER_HTTP_PORT=9200 \
            -e CL_L0_TOKEN_IDENTIFIER=${TOKEN_ID} \
            ${{ env.IMAGE }}:${{ env.IMAGE_TAG }} \
            java -Xmx4g -Xms2g -jar /ottochain/jars/dl1.jar run-initial-validator"

          for i in $(seq 1 60); do
            state=$(ssh node1 'curl -sf http://localhost:9400/node/info | jq -r .state' || echo "")
            if [ "$state" = "Ready" ]; then break; fi
            sleep 5
          done

          DL1_PEER_ID=$(ssh node1 'curl -sf http://localhost:9400/node/info | jq -r .id' || echo "")

          # CRITICAL: Each L1 node needs a DIFFERENT key for consensus
          # node2 uses keys2, node3 uses keys3
          for host_info in "node2:${NODE2_IP}:keys2" "node3:${NODE3_IP}:keys3"; do
            HOST="${host_info%%:*}"
            rest="${host_info#*:}"
            IP="${rest%%:*}"
            KEYS="${rest##*:}"
            ssh $HOST "docker run -d --name dl1 \
              --restart unless-stopped \
              --entrypoint '' \
              -p 9400:9400 -p 9401:9401 -p 9402:9402 \
              -v /opt/ottochain/${KEYS}:/ottochain/keys:ro \
              -v /opt/ottochain/data:/ottochain/data \
              -e CL_KEYSTORE=/ottochain/keys/key.p12 \
              -e CL_KEYALIAS=alias \
              -e CL_PASSWORD='${{ secrets.CL_KEYSTORE_PASSWORD }}' \
              -e CL_APP_ENV=dev \
              -e CL_PUBLIC_HTTP_PORT=9400 \
              -e CL_P2P_HTTP_PORT=9401 \
              -e CL_CLI_HTTP_PORT=9402 \
              -e CL_EXTERNAL_IP=${IP} \
              -e CL_COLLATERAL=0 \
              -e CL_GLOBAL_L0_PEER_ID=${GL0_PEER_ID} \
              -e CL_GLOBAL_L0_PEER_HTTP_HOST=${NODE1_IP} \
              -e CL_GLOBAL_L0_PEER_HTTP_PORT=9000 \
              -e CL_L0_PEER_ID=${ML0_PEER_ID} \
              -e CL_L0_PEER_HTTP_HOST=${NODE1_IP} \
              -e CL_L0_PEER_HTTP_PORT=9200 \
              -e CL_L0_TOKEN_IDENTIFIER=${TOKEN_ID} \
              ${{ env.IMAGE }}:${{ env.IMAGE_TAG }} \
              java -Xmx4g -Xms2g -jar /ottochain/jars/dl1.jar run-validator"
          done

          sleep 25

          if [ -n "$DL1_PEER_ID" ] && [ "$DL1_PEER_ID" != "null" ]; then
            for host in node2 node3; do
              ssh $host "docker exec dl1 curl -sf -X POST http://127.0.0.1:9402/cluster/join \
                -H 'Content-Type: application/json' \
                -d '{\"id\": \"${DL1_PEER_ID}\", \"ip\": \"${NODE1_IP}\", \"p2pPort\": 9401}'" || true
            done
          fi

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() && needs.deploy.result == 'success'

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/hetzner
          chmod 600 ~/.ssh/hetzner
          for host in node1 node2 node3; do
            case $host in
              node1) ip="${{ secrets.HETZNER_NODE1_IP }}" ;;
              node2) ip="${{ secrets.HETZNER_NODE2_IP }}" ;;
              node3) ip="${{ secrets.HETZNER_NODE3_IP }}" ;;
            esac
            cat >> ~/.ssh/config << EOF
          Host $host
            HostName $ip
            User root
            IdentityFile ~/.ssh/hetzner
            StrictHostKeyChecking no
          EOF
          done

      - name: Check all layers
        run: |
          echo "=== OttoChain 5-Layer Cluster Health ==="
          FAILED=0

          for layer in gl0 gl1 ml0 cl1 dl1; do
            case $layer in
              gl0) port=9000 ;; gl1) port=9100 ;; ml0) port=9200 ;; cl1) port=9300 ;; dl1) port=9400 ;;
            esac
            state=$(ssh node1 "curl -sf http://localhost:$port/node/info | jq -r .state" || echo "DOWN")
            cluster=$(ssh node1 "curl -sf http://localhost:$port/cluster/info | jq length" || echo "0")
            STATUS="âœ…"
            if [ "$state" != "Ready" ]; then STATUS="âŒ"; FAILED=$((FAILED + 1)); fi
            echo "$STATUS $layer: $state (cluster: $cluster)"
          done

          if [ "$FAILED" -gt 0 ]; then echo "::warning::$FAILED layer(s) not Ready"; fi

      - name: Verify L1 peer ID uniqueness
        run: |
          echo "=== Verifying L1 nodes have unique peer IDs ==="
          
          # Collect DL1 peer IDs from all nodes
          DL1_1=$(ssh node1 "curl -sf http://localhost:9400/node/info | jq -r .id" || echo "error")
          DL1_2=$(ssh node2 "curl -sf http://localhost:9400/node/info | jq -r .id" || echo "error")
          DL1_3=$(ssh node3 "curl -sf http://localhost:9400/node/info | jq -r .id" || echo "error")
          
          echo "DL1 node1: ${DL1_1:0:32}..."
          echo "DL1 node2: ${DL1_2:0:32}..."
          echo "DL1 node3: ${DL1_3:0:32}..."
          
          if [ "$DL1_1" = "$DL1_2" ] || [ "$DL1_1" = "$DL1_3" ] || [ "$DL1_2" = "$DL1_3" ]; then
            echo "::error::DL1 nodes have DUPLICATE peer IDs! L1 consensus will fail."
            echo "This means nodes are using the same key.p12 file."
            exit 1
          fi
          
          echo "âœ“ All DL1 nodes have unique peer IDs - consensus should work"

      - name: Summary
        run: |
          echo "## ðŸš€ Metagraph Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image**: \`${{ env.IMAGE }}:${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Layer | Port | State | Cluster |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|-------|---------|" >> $GITHUB_STEP_SUMMARY

          for layer in GL0 GL1 ML0 CL1 DL1; do
            case $layer in
              GL0) port=9000 ;; GL1) port=9100 ;; ML0) port=9200 ;; CL1) port=9300 ;; DL1) port=9400 ;;
            esac
            state=$(ssh node1 "curl -sf http://localhost:$port/node/info | jq -r .state" 2>/dev/null || echo "?")
            cluster=$(ssh node1 "curl -sf http://localhost:$port/cluster/info | jq length" 2>/dev/null || echo "?")
            ICON="âœ…"; [ "$state" != "Ready" ] && ICON="âŒ"
            echo "| $ICON $layer | $port | $state | $cluster |" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**GL0 Peer ID**: \`${{ needs.deploy.outputs.gl0_peer_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**ML0 Peer ID**: \`${{ needs.deploy.outputs.ml0_peer_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Token ID**: \`${{ needs.deploy.outputs.token_id }}\`" >> $GITHUB_STEP_SUMMARY
