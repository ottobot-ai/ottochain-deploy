name: Deploy Full Stack

on:
  push:
    branches:
      - release/scratch
      - release/beta
      - release/staging
      - release/prod
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'scratch'
        type: choice
        options:
          - scratch
          - beta
          - staging
          - prod
      wipe_state:
        description: 'Wipe all state (genesis reset)'
        required: true
        default: 'false'
        type: boolean
      metagraph_version:
        description: 'Metagraph image tag (e.g., latest, v0.6.0, sha)'
        required: false
        default: 'latest'
        type: string
      services_version:
        description: 'Services image version'
        required: false
        default: 'latest'
        type: string
      explorer_version:
        description: 'Explorer image version'
        required: false
        default: 'latest'
        type: string
      skip_metagraph:
        description: 'Skip metagraph deployment'
        required: false
        default: false
        type: boolean
      skip_services:
        description: 'Skip services deployment'
        required: false
        default: false
        type: boolean
      skip_monitoring:
        description: 'Skip monitoring deployment'
        required: false
        default: false
        type: boolean

jobs:
  # Determine environment from branch or input
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            ENV="${{ github.ref_name }}"
            ENV="${ENV#release/}"
          else
            ENV="${{ inputs.environment }}"
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "Deploying to: $ENV"

  # Deploy metagraph (5-layer cluster)
  metagraph:
    name: Metagraph
    needs: [setup]
    if: ${{ inputs.skip_metagraph != true }}
    uses: ./.github/workflows/deploy-metagraph.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}
      wipe_state: ${{ inputs.wipe_state == true }}
      image_tag: ${{ inputs.metagraph_version || 'latest' }}
    secrets: inherit

  # Deploy services (docker compose stack)
  services:
    name: Services
    needs: [setup, metagraph]
    if: always() && inputs.skip_services != true && (needs.metagraph.result == 'success' || needs.metagraph.result == 'skipped')
    uses: ./.github/workflows/deploy-services.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}
      services_version: ${{ inputs.services_version || 'latest' }}
      explorer_version: ${{ inputs.explorer_version || 'latest' }}
      reset_db: ${{ inputs.wipe_state == true }}
    secrets: inherit

  # Deploy monitoring (prometheus, grafana, alertmanager)
  monitoring:
    name: Monitoring
    needs: [setup, services]
    if: always() && inputs.skip_monitoring != true && (needs.services.result == 'success' || needs.services.result == 'skipped')
    uses: ./.github/workflows/deploy-monitoring.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}
      include_exporters: true
    secrets: inherit

  # Update compatibility matrix
  compatibility:
    name: Update Compatibility
    runs-on: ubuntu-latest
    needs: [setup, metagraph, services, monitoring]
    if: always() && (needs.metagraph.result == 'success' || needs.services.result == 'success')
    
    steps:
      - name: Compute target branch
        id: target
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          BRANCH="release/${ENV}"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "env=$ENV" >> "$GITHUB_OUTPUT"

      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.target.outputs.branch }}

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Generate compatibility matrix
        run: |
          chmod +x scripts/generate-compatibility.sh
          ./scripts/generate-compatibility.sh

      - name: Update deployed versions
        env:
          TARGET_ENV: ${{ steps.target.outputs.env }}
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          yq -i ".deployed.${TARGET_ENV}.ottochain = .components.ottochain.version" versions.yml
          yq -i ".deployed.${TARGET_ENV}.services = .components.services.version" versions.yml
          yq -i ".deployed.${TARGET_ENV}.explorer = .components.explorer.version" versions.yml
          yq -i ".deployed.${TARGET_ENV}.timestamp = \"$TIMESTAMP\"" versions.yml
          yq -i ".deployed.${TARGET_ENV}.workflow_run = \"${{ github.run_id }}\"" versions.yml

      - name: Commit changes
        env:
          TARGET_BRANCH: ${{ steps.target.outputs.branch }}
          TARGET_ENV: ${{ steps.target.outputs.env }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add COMPATIBILITY.md versions.yml
          git diff --staged --quiet || git commit -m "chore: update ${TARGET_ENV} compatibility matrix [skip ci]"
          git push origin "${TARGET_BRANCH}"

  # Final summary
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [setup, metagraph, services, monitoring, compatibility]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Full Stack Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Wipe State**: ${{ inputs.wipe_state }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Metagraph | ${{ needs.metagraph.result == 'success' && 'âœ…' || needs.metagraph.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.metagraph.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Services | ${{ needs.services.result == 'success' && 'âœ…' || needs.services.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.services.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Monitoring | ${{ needs.monitoring.result == 'success' && 'âœ…' || needs.monitoring.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.monitoring.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Compatibility | ${{ needs.compatibility.result == 'success' && 'âœ…' || 'âš ï¸' }} ${{ needs.compatibility.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Versions" >> $GITHUB_STEP_SUMMARY
          echo "- **Metagraph**: ${{ inputs.metagraph_version || 'main' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Services**: ${{ inputs.services_version || 'latest' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Explorer**: ${{ inputs.explorer_version || 'latest' }}" >> $GITHUB_STEP_SUMMARY
