# Metagraph - 5-Layer Tessellation Stack (GL0, GL1, ML0, CL1, DL1)
# Usage: 
#   Genesis node:    NODE_IP=x.x.x.x docker compose -f compose/metagraph.yml --profile genesis up -d
#   Validator nodes: NODE_IP=x.x.x.x GENESIS_IP=y.y.y.y docker compose -f compose/metagraph.yml --profile validator up -d
#
# Requires: /opt/ottochain/{keys,jars,genesis,data} on host

x-common: &common
  image: ${METAGRAPH_IMAGE:-eclipse-temurin:21-jdk}
  restart: unless-stopped
  network_mode: host
  logging:
    driver: json-file
    options:
      max-size: "100m"
      max-file: "3"
  volumes:
    - /opt/ottochain/keys:/keys:ro
    - /opt/ottochain/jars:/jars:ro
  environment: &common-env
    CL_KEYSTORE: /keys/key.p12
    CL_KEYALIAS: ${CL_KEYALIAS:-alias}
    CL_PASSWORD: ${CL_PASSWORD}
    CL_APP_ENV: ${CL_APP_ENV:-dev}
    CL_COLLATERAL: "0"
    CL_EXTERNAL_IP: ${NODE_IP}
    JAVA_OPTS: ${JAVA_OPTS:--Xmx2g -Xms1g}

services:
  # ===== GL0 - Global L0 =====
  gl0-genesis:
    <<: *common
    container_name: gl0
    profiles: ["genesis"]
    command: ["java", "-jar", "/jars/dag-l0.jar", "run-genesis", "/genesis/genesis.csv"]
    volumes:
      - /opt/ottochain/keys:/keys:ro
      - /opt/ottochain/jars:/jars:ro
      - /opt/ottochain/genesis:/genesis:ro
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9000"
      CL_P2P_HTTP_PORT: "9001"
      CL_CLI_HTTP_PORT: "9002"

  gl0-validator:
    <<: *common
    container_name: gl0
    profiles: ["validator"]
    command: ["java", "-jar", "/jars/dag-l0.jar", "run-validator"]
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9000"
      CL_P2P_HTTP_PORT: "9001"
      CL_CLI_HTTP_PORT: "9002"
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: "9000"
      CL_GLOBAL_L0_PEER_ID: ${GL0_PEER_ID}

  # ===== GL1 - Global L1 =====
  gl1-initial:
    <<: *common
    container_name: gl1
    profiles: ["genesis"]
    command: ["java", "-jar", "/jars/dag-l1.jar", "run-initial-validator"]
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9100"
      CL_P2P_HTTP_PORT: "9101"
      CL_CLI_HTTP_PORT: "9102"
      CL_L0_PEER_HTTP_HOST: ${NODE_IP}
      CL_L0_PEER_HTTP_PORT: "9000"
      CL_L0_PEER_ID: ${GL0_PEER_ID}

  gl1-validator:
    <<: *common
    container_name: gl1
    profiles: ["validator"]
    command: ["java", "-jar", "/jars/dag-l1.jar", "run-validator"]
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9100"
      CL_P2P_HTTP_PORT: "9101"
      CL_CLI_HTTP_PORT: "9102"
      CL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_L0_PEER_HTTP_PORT: "9000"
      CL_L0_PEER_ID: ${GL0_PEER_ID}

  # ===== ML0 - Metagraph L0 =====
  ml0-genesis:
    <<: *common
    container_name: ml0
    profiles: ["genesis"]
    command: ["java", "-jar", "/jars/metagraph-l0.jar", "run-genesis", "/data/genesis.snapshot"]
    volumes:
      - /opt/ottochain/keys:/keys:ro
      - /opt/ottochain/jars:/jars:ro
      - /opt/ottochain/data:/data
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9200"
      CL_P2P_HTTP_PORT: "9201"
      CL_CLI_HTTP_PORT: "9202"
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${NODE_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: "9000"
      CL_GLOBAL_L0_PEER_ID: ${GL0_PEER_ID}

  ml0-validator:
    <<: *common
    container_name: ml0
    profiles: ["validator"]
    command: ["java", "-jar", "/jars/metagraph-l0.jar", "run-validator"]
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9200"
      CL_P2P_HTTP_PORT: "9201"
      CL_CLI_HTTP_PORT: "9202"
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: "9000"
      CL_GLOBAL_L0_PEER_ID: ${GL0_PEER_ID}
      CL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_L0_PEER_HTTP_PORT: "9200"
      CL_L0_PEER_ID: ${ML0_PEER_ID}
      CL_L0_TOKEN_IDENTIFIER: ${TOKEN_ID}

  # ===== CL1 - Currency L1 =====
  cl1-initial:
    <<: *common
    container_name: cl1
    profiles: ["genesis"]
    command: ["java", "-jar", "/jars/currency-l1.jar", "run-initial-validator"]
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9300"
      CL_P2P_HTTP_PORT: "9301"
      CL_CLI_HTTP_PORT: "9302"
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${NODE_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: "9000"
      CL_GLOBAL_L0_PEER_ID: ${GL0_PEER_ID}
      CL_L0_PEER_HTTP_HOST: ${NODE_IP}
      CL_L0_PEER_HTTP_PORT: "9200"
      CL_L0_PEER_ID: ${ML0_PEER_ID}
      CL_L0_TOKEN_IDENTIFIER: ${TOKEN_ID}

  cl1-validator:
    <<: *common
    container_name: cl1
    profiles: ["validator"]
    command: ["java", "-jar", "/jars/currency-l1.jar", "run-validator"]
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9300"
      CL_P2P_HTTP_PORT: "9301"
      CL_CLI_HTTP_PORT: "9302"
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: "9000"
      CL_GLOBAL_L0_PEER_ID: ${GL0_PEER_ID}
      CL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_L0_PEER_HTTP_PORT: "9200"
      CL_L0_PEER_ID: ${ML0_PEER_ID}
      CL_L0_TOKEN_IDENTIFIER: ${TOKEN_ID}

  # ===== DL1 - Data L1 =====
  dl1-initial:
    <<: *common
    container_name: dl1
    profiles: ["genesis"]
    command: ["java", "-jar", "/jars/data-l1.jar", "run-initial-validator"]
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9400"
      CL_P2P_HTTP_PORT: "9401"
      CL_CLI_HTTP_PORT: "9402"
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${NODE_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: "9000"
      CL_GLOBAL_L0_PEER_ID: ${GL0_PEER_ID}
      CL_L0_PEER_HTTP_HOST: ${NODE_IP}
      CL_L0_PEER_HTTP_PORT: "9200"
      CL_L0_PEER_ID: ${ML0_PEER_ID}
      CL_L0_TOKEN_IDENTIFIER: ${TOKEN_ID}

  dl1-validator:
    <<: *common
    container_name: dl1
    profiles: ["validator"]
    command: ["java", "-jar", "/jars/data-l1.jar", "run-validator"]
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9400"
      CL_P2P_HTTP_PORT: "9401"
      CL_CLI_HTTP_PORT: "9402"
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: "9000"
      CL_GLOBAL_L0_PEER_ID: ${GL0_PEER_ID}
      CL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_L0_PEER_HTTP_PORT: "9200"
      CL_L0_PEER_ID: ${ML0_PEER_ID}
      CL_L0_TOKEN_IDENTIFIER: ${TOKEN_ID}
