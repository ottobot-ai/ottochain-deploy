# OttoChain Metagraph - Full 5-Layer Stack
# Each node runs all 5 layers. Use profiles for genesis vs validator.
#
# Usage on node1 (genesis):
#   NODE_IP=5.78.90.207 docker compose --profile genesis up -d
#
# Usage on node2/node3 (validators):
#   NODE_IP=<this-node-ip> GENESIS_IP=5.78.90.207 docker compose --profile validator up -d

x-common: &common
  restart: unless-stopped
  network_mode: host
  logging:
    driver: json-file
    options:
      max-size: "100m"
      max-file: "3"
  volumes:
    - /opt/ottochain/keys:/keys:ro
  environment: &common-env
    CL_KEYSTORE: /keys/key.p12
    CL_KEYALIAS: ${CL_KEYALIAS:-alias}
    CL_PASSWORD: ${CL_PASSWORD}
    CL_APP_ENV: dev
    CL_COLLATERAL: "0"
    CL_EXTERNAL_IP: ${NODE_IP}
    JAVA_OPTS: "-Xmx2g -Xms1g"

services:
  # ============================================
  # GL0 - Global L0 (DAG Consensus)
  # ============================================
  gl0-genesis:
    <<: *common
    image: ${GL0_IMAGE:-eclipse-temurin:21-jdk}
    container_name: gl0
    profiles: ["genesis"]
    command: ["java", "-jar", "/jars/dag-l0.jar", "run-genesis", "/genesis/genesis.csv"]
    volumes:
      - /opt/ottochain/keys:/keys:ro
      - /opt/ottochain/jars:/jars:ro
      - /opt/ottochain/genesis:/genesis:ro
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9000"
      CL_P2P_HTTP_PORT: "9001"
      CL_CLI_HTTP_PORT: "9002"

  gl0-validator:
    <<: *common
    image: ${GL0_IMAGE:-eclipse-temurin:21-jdk}
    container_name: gl0
    profiles: ["validator"]
    command: ["java", "-jar", "/jars/dag-l0.jar", "run-validator"]
    volumes:
      - /opt/ottochain/keys:/keys:ro
      - /opt/ottochain/jars:/jars:ro
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9000"
      CL_P2P_HTTP_PORT: "9001"
      CL_CLI_HTTP_PORT: "9002"
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: "9000"
      CL_GLOBAL_L0_PEER_ID: ${GL0_PEER_ID}

  # ============================================
  # GL1 - Global L1 (DAG Transactions)
  # ============================================
  gl1-initial:
    <<: *common
    image: ${GL1_IMAGE:-eclipse-temurin:21-jdk}
    container_name: gl1
    profiles: ["genesis"]
    command: ["java", "-jar", "/jars/dag-l1.jar", "run-initial-validator"]
    volumes:
      - /opt/ottochain/keys:/keys:ro
      - /opt/ottochain/jars:/jars:ro
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9100"
      CL_P2P_HTTP_PORT: "9101"
      CL_CLI_HTTP_PORT: "9102"
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${NODE_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: "9000"
      CL_GLOBAL_L0_PEER_ID: ${GL0_PEER_ID}

  gl1-validator:
    <<: *common
    image: ${GL1_IMAGE:-eclipse-temurin:21-jdk}
    container_name: gl1
    profiles: ["validator"]
    command: ["java", "-jar", "/jars/dag-l1.jar", "run-validator"]
    volumes:
      - /opt/ottochain/keys:/keys:ro
      - /opt/ottochain/jars:/jars:ro
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9100"
      CL_P2P_HTTP_PORT: "9101"
      CL_CLI_HTTP_PORT: "9102"
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: "9000"
      CL_GLOBAL_L0_PEER_ID: ${GL0_PEER_ID}
      CL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_L0_PEER_HTTP_PORT: "9100"
      CL_L0_PEER_ID: ${GL1_PEER_ID}

  # ============================================
  # ML0 - Metagraph L0 (OttoChain Consensus)
  # ============================================
  ml0-genesis:
    <<: *common
    image: ${ML0_IMAGE:-eclipse-temurin:21-jdk}
    container_name: ml0
    profiles: ["genesis"]
    command: ["java", "-jar", "/jars/metagraph-l0.jar", "run-genesis", "/data/genesis.snapshot"]
    volumes:
      - /opt/ottochain/keys:/keys:ro
      - /opt/ottochain/jars:/jars:ro
      - /opt/ottochain/data:/data
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9200"
      CL_P2P_HTTP_PORT: "9201"
      CL_CLI_HTTP_PORT: "9202"
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${NODE_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: "9000"
      CL_GLOBAL_L0_PEER_ID: ${GL0_PEER_ID}

  ml0-validator:
    <<: *common
    image: ${ML0_IMAGE:-eclipse-temurin:21-jdk}
    container_name: ml0
    profiles: ["validator"]
    command: ["java", "-jar", "/jars/metagraph-l0.jar", "run-validator"]
    volumes:
      - /opt/ottochain/keys:/keys:ro
      - /opt/ottochain/jars:/jars:ro
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9200"
      CL_P2P_HTTP_PORT: "9201"
      CL_CLI_HTTP_PORT: "9202"
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: "9000"
      CL_GLOBAL_L0_PEER_ID: ${GL0_PEER_ID}
      CL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_L0_PEER_HTTP_PORT: "9200"
      CL_L0_PEER_ID: ${ML0_PEER_ID}
      CL_L0_TOKEN_IDENTIFIER: ${TOKEN_ID}

  # ============================================
  # CL1 - Currency L1 (OttoChain Tokens)
  # ============================================
  cl1-initial:
    <<: *common
    image: ${CL1_IMAGE:-eclipse-temurin:21-jdk}
    container_name: cl1
    profiles: ["genesis"]
    command: ["java", "-jar", "/jars/currency-l1.jar", "run-initial-validator"]
    volumes:
      - /opt/ottochain/keys:/keys:ro
      - /opt/ottochain/jars:/jars:ro
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9300"
      CL_P2P_HTTP_PORT: "9301"
      CL_CLI_HTTP_PORT: "9302"
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${NODE_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: "9000"
      CL_GLOBAL_L0_PEER_ID: ${GL0_PEER_ID}
      CL_L0_PEER_HTTP_HOST: ${NODE_IP}
      CL_L0_PEER_HTTP_PORT: "9200"
      CL_L0_PEER_ID: ${ML0_PEER_ID}
      CL_L0_TOKEN_IDENTIFIER: ${TOKEN_ID}

  cl1-validator:
    <<: *common
    image: ${CL1_IMAGE:-eclipse-temurin:21-jdk}
    container_name: cl1
    profiles: ["validator"]
    command: ["java", "-jar", "/jars/currency-l1.jar", "run-validator"]
    volumes:
      - /opt/ottochain/keys:/keys:ro
      - /opt/ottochain/jars:/jars:ro
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9300"
      CL_P2P_HTTP_PORT: "9301"
      CL_CLI_HTTP_PORT: "9302"
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: "9000"
      CL_GLOBAL_L0_PEER_ID: ${GL0_PEER_ID}
      CL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_L0_PEER_HTTP_PORT: "9200"
      CL_L0_PEER_ID: ${ML0_PEER_ID}
      CL_L0_TOKEN_IDENTIFIER: ${TOKEN_ID}

  # ============================================
  # DL1 - Data L1 (OttoChain State Machines)
  # ============================================
  dl1-initial:
    <<: *common
    image: ${DL1_IMAGE:-eclipse-temurin:21-jdk}
    container_name: dl1
    profiles: ["genesis"]
    command: ["java", "-jar", "/jars/data-l1.jar", "run-initial-validator"]
    volumes:
      - /opt/ottochain/keys:/keys:ro
      - /opt/ottochain/jars:/jars:ro
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9400"
      CL_P2P_HTTP_PORT: "9401"
      CL_CLI_HTTP_PORT: "9402"
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${NODE_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: "9000"
      CL_GLOBAL_L0_PEER_ID: ${GL0_PEER_ID}
      CL_L0_PEER_HTTP_HOST: ${NODE_IP}
      CL_L0_PEER_HTTP_PORT: "9200"
      CL_L0_PEER_ID: ${ML0_PEER_ID}
      CL_L0_TOKEN_IDENTIFIER: ${TOKEN_ID}

  dl1-validator:
    <<: *common
    image: ${DL1_IMAGE:-eclipse-temurin:21-jdk}
    container_name: dl1
    profiles: ["validator"]
    command: ["java", "-jar", "/jars/data-l1.jar", "run-validator"]
    volumes:
      - /opt/ottochain/keys:/keys:ro
      - /opt/ottochain/jars:/jars:ro
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: "9400"
      CL_P2P_HTTP_PORT: "9401"
      CL_CLI_HTTP_PORT: "9402"
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: "9000"
      CL_GLOBAL_L0_PEER_ID: ${GL0_PEER_ID}
      CL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_L0_PEER_HTTP_PORT: "9200"
      CL_L0_PEER_ID: ${ML0_PEER_ID}
      CL_L0_TOKEN_IDENTIFIER: ${TOKEN_ID}
