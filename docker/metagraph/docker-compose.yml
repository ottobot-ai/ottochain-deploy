# OttoChain Metagraph Node Stack
# Deploy on each metagraph node (node1, node2, node3)
#
# Usage:
#   # Genesis node (node1):
#   docker compose --profile genesis up -d
#
#   # Validator nodes (node2, node3):
#   docker compose --profile validator up -d

x-common: &common
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: "100m"
      max-file: "3"
  volumes:
    - ./keys:/keys:ro
  environment: &common-env
    CL_KEYSTORE: /keys/cl-keystore.p12
    CL_KEYSTORE_PASSWORD: ${CL_KEYSTORE_PASSWORD}
    CL_KEY_ALIAS: cl-keystore
    JAVA_OPTS: "-Xmx2g -Xms1g"

services:
  # ============================================
  # Global L0 - Genesis (only on node1)
  # ============================================
  gl0-genesis:
    <<: *common
    image: ghcr.io/ottobot-ai/ottochain-gl0:${VERSION:-latest}
    container_name: gl0
    profiles: ["genesis"]
    command: ["run-genesis", "/data/genesis.snapshot"]
    ports:
      - "9000:9000"  # Public HTTP
      - "9001:9001"  # P2P
      - "9002:9002"  # CLI
    volumes:
      - ./keys:/keys:ro
      - gl0-data:/data
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: 9000
      CL_P2P_HTTP_PORT: 9001
      CL_CLI_HTTP_PORT: 9002
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/node/info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================
  # Global L0 - Validator (on node2, node3)
  # ============================================
  gl0-validator:
    <<: *common
    image: ghcr.io/ottobot-ai/ottochain-gl0:${VERSION:-latest}
    container_name: gl0
    profiles: ["validator"]
    command: ["run-validator"]
    network_mode: host
    volumes:
      - ./keys:/keys:ro
      - gl0-data:/data
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: 9000
      CL_P2P_HTTP_PORT: 9001
      CL_CLI_HTTP_PORT: 9002
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: 9000
      CL_GLOBAL_L0_PEER_ID: ${GENESIS_GL0_ID}

  # ============================================
  # Metagraph L0 (only on node1 for now)
  # ============================================
  ml0:
    <<: *common
    image: ghcr.io/ottobot-ai/ottochain-ml0:${VERSION:-latest}
    container_name: ml0
    profiles: ["genesis"]
    command: ["run-genesis", "/data/genesis.snapshot"]
    network_mode: host
    volumes:
      - ./keys:/keys:ro
      - ml0-data:/data
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: 9200
      CL_P2P_HTTP_PORT: 9201
      CL_CLI_HTTP_PORT: 9202
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${GENESIS_IP:-127.0.0.1}
      CL_GLOBAL_L0_PEER_HTTP_PORT: 9000
      CL_GLOBAL_L0_PEER_ID: ${GENESIS_GL0_ID}
    depends_on:
      gl0-genesis:
        condition: service_healthy

  # ============================================
  # Currency L1 (on all nodes)
  # ============================================
  cl1:
    <<: *common
    image: ghcr.io/ottobot-ai/ottochain-cl1:${VERSION:-latest}
    container_name: cl1
    network_mode: host
    volumes:
      - ./keys:/keys:ro
      - cl1-data:/data
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: 9300
      CL_P2P_HTTP_PORT: 9301
      CL_CLI_HTTP_PORT: 9302
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: 9000
      CL_GLOBAL_L0_PEER_ID: ${GENESIS_GL0_ID}
      CL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_L0_PEER_HTTP_PORT: 9200
      CL_L0_PEER_ID: ${ML0_ID}
      CL_L0_TOKEN_IDENTIFIER: ${TOKEN_ID:-DAG0JjJkmwDn8s9QTyykPRqnvkagxSkrLfDG1mYz}

  # ============================================
  # Data L1 (on all nodes)
  # ============================================
  dl1:
    <<: *common
    image: ghcr.io/ottobot-ai/ottochain-dl1:${VERSION:-latest}
    container_name: dl1
    network_mode: host
    volumes:
      - ./keys:/keys:ro
      - dl1-data:/data
    environment:
      <<: *common-env
      CL_PUBLIC_HTTP_PORT: 9400
      CL_P2P_HTTP_PORT: 9401
      CL_CLI_HTTP_PORT: 9402
      CL_GLOBAL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_GLOBAL_L0_PEER_HTTP_PORT: 9000
      CL_GLOBAL_L0_PEER_ID: ${GENESIS_GL0_ID}
      CL_L0_PEER_HTTP_HOST: ${GENESIS_IP}
      CL_L0_PEER_HTTP_PORT: 9200
      CL_L0_PEER_ID: ${ML0_ID}
      CL_L0_TOKEN_IDENTIFIER: ${TOKEN_ID:-DAG0JjJkmwDn8s9QTyykPRqnvkagxSkrLfDG1mYz}

volumes:
  gl0-data:
  ml0-data:
  cl1-data:
  dl1-data:
